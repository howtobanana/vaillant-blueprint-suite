blueprint:
  name: "(Vaillant) L√ºftungs-Steuerung"
  description: |
    ü™ü **Modul 3: L√ºftungs-Assistent**

    Managt das Sto√ül√ºften und sch√ºtzt vor vergessenen Fenstern. Unabh√§ngig von der Heizung.

    **Funktionen:**
    - üå¨Ô∏è Erinnerung zum L√ºften (Zeit, CO2 oder Feuchte).
    - ‚è±Ô∏è Close-Timer: Erinnert ans Schlie√üen nach X Minuten.
    - üö® Eskalation: Nerviger Alarm, wenn Fenster offen bleiben.
    - üåßÔ∏è Sicherheits-Warnung bei Regen oder Verlassen des Hauses.

    **Info:**
    Dieses Modul sendet nur Nachrichten. Das "Core Heating" Modul erkennt die offenen Fenster separat und stoppt die Heizung automatisch.

    **Autor:** bananapower | **Version:** v1.0 (Microservices Edition)

  domain: automation
  source_url: https://raw.githubusercontent.com/howtobanana/vaillant-blueprint/main/blueprints/vaillant_l%C3%BCftungs-steuerung.yaml
  author: "bananapower"

  input:
    section_global:
      name: "üåç Global: Wetter, Away & Notifications"
      description: |
        Zentrale Konfiguration f√ºr Wetter, Away-Status, Reminder und Benachrichtigungen.
        Diese Werte gelten f√ºr alle R√§ume.
      collapsed: false
      input:
        weather_entity:
          name: "üåßÔ∏è Wetter-Entity"
          description: |
            Weather-Entity f√ºr Regenstatus und Regenprognose (z.B. weather.home).
          selector:
            entity:
              domain: weather
        away_mode_boolean:
          name: "üè† Away-Mode Helper"
          description: |
            Global Away-Helper for safety check (same as Core Heating).
          selector:
            entity:
              domain: input_boolean

        enable_daily_reminder:
          name: "üîò T√§gliche Erinnerung aktiv"
          description: |
            Schalter: T√§glichen Reminder zur Reminder-Zeit senden.
          default: true
          selector:
            boolean:
        reminder_time:
          name: "üïê Reminder-Zeit"
          description: |
            Beispiel: 13:00 Uhr.
          default: "13:00:00"
          selector:
            time:
        co2_sensor:
          name: "ü´ß CO2 Sensor (opt)"
          description: |
            Optionaler CO2-Sensor f√ºr bedarfsbasierte L√ºftungs-Reminder.
          default: ""
          selector:
            entity:
              domain: sensor
        co2_threshold:
          name: "ü´ß CO2 Grenzwert (ppm)"
          description: |
            Reminder ausl√∂sen, wenn CO2 dar√ºber liegt.
          default: 1200
          selector:
            number:
              min: 600
              max: 4000
              step: 50
              unit_of_measurement: "ppm"
        humidity_sensor:
          name: "üíß Luftfeuchte Sensor (opt)"
          description: |
            Optionaler Feuchtesensor f√ºr bedarfsbasierte L√ºftungs-Reminder.
          default: ""
          selector:
            entity:
              domain: sensor
              device_class:
                - humidity
        humidity_threshold:
          name: "üíß Feuchte Grenzwert (%)"
          description: |
            Reminder ausl√∂sen, wenn Luftfeuchte dar√ºber liegt.
          default: 60
          selector:
            number:
              min: 40
              max: 90
              step: 1
              unit_of_measurement: "%"

        airing_duration:
          name: "ü™ü L√ºftungsdauer (min)"
          description: |
            Wie lange Fenster f√ºr Sto√ül√ºften offen bleiben sollen.
          default: 10
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: "min"
        escalation_delay:
          name: "‚ö†Ô∏è Eskalations-Delay (min)"
          description: |
            Wie lange nach dem "Bitte schlie√üen" Reminder bis kritische Alerts starten.
          default: 5
          selector:
            number:
              min: 1
              max: 60
              step: 1
              unit_of_measurement: "min"

        notify_device:
          name: "üì© Notify Ger√§t (Normal)"
          description: |
            Mobile-App Ger√§t f√ºr Standard-Reminder.
          default: ""
          selector:
            device:
              filter:
                integration: mobile_app
        critical_notify_device:
          name: "üö® Notify Ger√§t (Critical)"
          description: |
            Mobile-App Ger√§t f√ºr kritische Alarm-Meldungen.
          default: ""
          selector:
            device:
              filter:
                integration: mobile_app

    section_master:
      name: "üè† Master-Raum"
      description: |
        Fensterkontakt f√ºr den Master-Bereich.
      collapsed: false
      input:
        master_window:
          name: "ü™ü Master Fensterkontakt"
          description: |
            Fensterkontakt des Master-Raums.
          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window

    section_room2:
      name: "üõèÔ∏è Raum 2"
      description: |
        Fensterkontakt f√ºr Raum 2.
      collapsed: true
      input:
        room2_window:
          name: "ü™ü Raum 2 Fensterkontakt"
          description: |
            Fensterkontakt von Raum 2.
          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window

    section_room3:
      name: "üíª Raum 3"
      description: |
        Fensterkontakt f√ºr Raum 3.
      collapsed: true
      input:
        room3_window:
          name: "ü™ü Raum 3 Fensterkontakt"
          description: |
            Fensterkontakt von Raum 3.
          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window

    section_room4:
      name: "üõÅ Raum 4"
      description: |
        Fensterkontakt f√ºr Raum 4.
      collapsed: true
      input:
        room4_window:
          name: "ü™ü Raum 4 Fensterkontakt"
          description: |
            Fensterkontakt von Raum 4.
          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window

    section_room5:
      name: "üç≥ Raum 5"
      description: |
        Fensterkontakt f√ºr Raum 5.
      collapsed: true
      input:
        room5_window:
          name: "ü™ü Raum 5 Fensterkontakt"
          description: |
            Fensterkontakt von Raum 5.
          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window

mode: restart

trigger_variables:
  tv_co2_sensor: !input co2_sensor
  tv_co2_threshold: !input co2_threshold
  tv_humidity_sensor: !input humidity_sensor
  tv_humidity_threshold: !input humidity_threshold

trigger:
  # Need Fresh Air
  - platform: time
    at: !input reminder_time
    id: need_fresh_air_time

  - platform: template
    value_template: >
      {{ tv_co2_sensor != '' and states(tv_co2_sensor) not in ['unknown', 'unavailable', 'none', ''] and (states(tv_co2_sensor) | float(0)) > (tv_co2_threshold | float(1200)) }}
    id: need_fresh_air_co2

  - platform: template
    value_template: >
      {{ tv_humidity_sensor != '' and states(tv_humidity_sensor) not in ['unknown', 'unavailable', 'none', ''] and (states(tv_humidity_sensor) | float(0)) > (tv_humidity_threshold | float(60)) }}
    id: need_fresh_air_humidity

  # Window opened (per room)
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input master_window
    id: master_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room2_window
    id: room2_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room3_window
    id: room3_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room4_window
    id: room4_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room5_window
    id: room5_window_change

  # Safety: Rain detected
  - platform: state
    entity_id: !input weather_entity
    to: "rainy"
    id: safety_rain
  - platform: state
    entity_id: !input weather_entity
    to: "pouring"
    id: safety_rain
  - platform: state
    entity_id: !input weather_entity
    to: "lightning-rainy"
    id: safety_rain
  - platform: state
    entity_id: !input weather_entity
    to: "hail"
    id: safety_rain
  - platform: state
    entity_id: !input weather_entity
    to: "snowy-rainy"
    id: safety_rain

  # Safety: Away Mode activated
  - platform: state
    entity_id: !input away_mode_boolean
    to: "on"
    id: safety_away_mode

condition: []

action:
  - variables:
      inputs:
        weather_entity: !input weather_entity
        away_mode_boolean: !input away_mode_boolean
        enable_daily_reminder: !input enable_daily_reminder
        reminder_time: !input reminder_time
        co2_sensor: !input co2_sensor
        co2_threshold: !input co2_threshold
        humidity_sensor: !input humidity_sensor
        humidity_threshold: !input humidity_threshold
        airing_duration: !input airing_duration
        escalation_delay: !input escalation_delay
        notify_device: !input notify_device
        critical_notify_device: !input critical_notify_device
        master_window: !input master_window
        room2_window: !input room2_window
        room3_window: !input room3_window
        room4_window: !input room4_window
        room5_window: !input room5_window

      window_entities: >
        {% set ns = namespace(items=[]) %}
        {% for w in [inputs.master_window, inputs.room2_window, inputs.room3_window, inputs.room4_window, inputs.room5_window] %}
          {% if w is string and (w | trim) != '' %}
            {% set ns.items = ns.items + [w] %}
          {% endif %}
        {% endfor %}
        {{ ns.items }}

      rain_states:
        - rainy
        - pouring
        - lightning
        - lightning-rainy
        - hail
        - snowy-rainy

      window_trigger_ids:
        - master_window_change
        - room2_window_change
        - room3_window_change
        - room4_window_change
        - room5_window_change

      away_mode_active: >
        {% if inputs.away_mode_boolean != '' %}
          {{ is_state(inputs.away_mode_boolean, 'on') }}
        {% else %}
          false
        {% endif %}

      is_night: "{{ is_state('sun.sun', 'below_horizon') }}"

      rain_now: "{{ states(inputs.weather_entity) in rain_states }}"

      co2_sensor_entity: >
        {% if inputs.co2_sensor is string %}
          {{ inputs.co2_sensor }}
        {% elif inputs.co2_sensor is iterable and inputs.co2_sensor is not string and (inputs.co2_sensor | length > 0) %}
          {{ inputs.co2_sensor[0] }}
        {% else %}

        {% endif %}

      humidity_sensor_entity: >
        {% if inputs.humidity_sensor is string %}
          {{ inputs.humidity_sensor }}
        {% elif inputs.humidity_sensor is iterable and inputs.humidity_sensor is not string and (inputs.humidity_sensor | length > 0) %}
          {{ inputs.humidity_sensor[0] }}
        {% else %}

        {% endif %}

      co2_eval_entity: >
        {% if trigger.id == 'need_fresh_air_co2' and trigger.entity_id is defined and trigger.entity_id is not none %}
          {{ trigger.entity_id }}
        {% else %}
          {{ co2_sensor_entity }}
        {% endif %}

      humidity_eval_entity: >
        {% if trigger.id == 'need_fresh_air_humidity' and trigger.entity_id is defined and trigger.entity_id is not none %}
          {{ trigger.entity_id }}
        {% else %}
          {{ humidity_sensor_entity }}
        {% endif %}

      co2_value: >
        {% if co2_eval_entity != '' and states(co2_eval_entity) not in ['unknown', 'unavailable', 'none', ''] %}
          {{ states(co2_eval_entity) | float(0) }}
        {% else %}
          0
        {% endif %}

      humidity_value: >
        {% if humidity_eval_entity != '' and states(humidity_eval_entity) not in ['unknown', 'unavailable', 'none', ''] %}
          {{ states(humidity_eval_entity) | float(0) }}
        {% else %}
          0
        {% endif %}

      co2_high: "{{ co2_eval_entity != '' and (co2_value | float(0)) > (inputs.co2_threshold | float(1200)) }}"
      humidity_high: "{{ humidity_eval_entity != '' and (humidity_value | float(0)) > (inputs.humidity_threshold | float(60)) }}"

      reminder_triggered: >
        {{
          (trigger.id == 'need_fresh_air_time' and (inputs.enable_daily_reminder | bool(false)))
          or (trigger.id in ['need_fresh_air_co2', 'need_fresh_air_humidity'])
        }}

      reminder_reason: >
        {% set reasons = [] %}
        {% if trigger.id == 'need_fresh_air_time' and (inputs.enable_daily_reminder | bool(false)) %}
          {% set reasons = reasons + ['Tageszeit erreicht (' ~ (inputs.reminder_time[:5] if inputs.reminder_time is string else 'Reminder') ~ ')'] %}
        {% endif %}
        {% if co2_high %}
          {% set reasons = reasons + ['CO2 hoch: ' ~ (co2_value | round(0)) ~ ' ppm'] %}
        {% endif %}
        {% if humidity_high %}
          {% set reasons = reasons + ['Luftfeuchte hoch: ' ~ (humidity_value | round(1)) ~ '%'] %}
        {% endif %}
        {{ reasons | join(' | ') }}

      open_windows_text: >
        {% set ns = namespace(items=[]) %}
        {% for w in window_entities %}
          {% if is_state(w, 'on') %}
            {% set label = state_attr(w, 'friendly_name') if state_attr(w, 'friendly_name') is not none else w %}
            {% set ns.items = ns.items + [label] %}
          {% endif %}
        {% endfor %}
        {{ ns.items | join(', ') if ns.items | length > 0 else 'Fenster' }}

      any_window_open: >
        {% if window_entities | length > 0 %}
          {{ expand(window_entities) | selectattr('state', 'eq', 'on') | list | length > 0 }}
        {% else %}
          false
        {% endif %}

      window_trigger_entity: >
        {% if trigger.event is defined and trigger.event.data is defined and trigger.event.data.entity_id is defined %}
          {{ trigger.event.data.entity_id }}
        {% elif trigger.entity_id is defined and trigger.entity_id is not none %}
          {{ trigger.entity_id }}
        {% else %}

        {% endif %}

      window_opened_trigger: >
        {% if trigger.id in window_trigger_ids and trigger.event is defined and trigger.event.data is defined and trigger.event.data.new_state is defined and trigger.event.data.new_state is not none and trigger.event.data.new_state.state is defined %}
          {{ trigger.event.data.new_state.state == 'on' }}
        {% else %}
          false
        {% endif %}

      trigger_window_name: >
        {% if window_trigger_entity | trim != '' %}
          {{ state_attr(window_trigger_entity, 'friendly_name') if state_attr(window_trigger_entity, 'friendly_name') is not none else window_trigger_entity }}
        {% else %}
          Fenster
        {% endif %}

      notify_service: >
        {% if inputs.notify_device is string and inputs.notify_device[:7] == 'notify.' %}
          {{ inputs.notify_device }}
        {% elif inputs.notify_device != '' %}
          {% set user_name = device_attr(inputs.notify_device, 'name_by_user') %}
          {% set dev_name = user_name if (user_name is string and (user_name | trim) != '') else device_attr(inputs.notify_device, 'name') %}
          {% if dev_name is string and (dev_name | trim) != '' %}
            {{ 'notify.mobile_app_' ~ ((dev_name | slugify) | replace('-', '_')) }}
          {% else %}
            ""
          {% endif %}
        {% else %}
          ""
        {% endif %}

      critical_service: >
        {% if inputs.critical_notify_device is string and inputs.critical_notify_device[:7] == 'notify.' %}
          {{ inputs.critical_notify_device }}
        {% elif inputs.critical_notify_device != '' %}
          {% set user_name = device_attr(inputs.critical_notify_device, 'name_by_user') %}
          {% set dev_name = user_name if (user_name is string and (user_name | trim) != '') else device_attr(inputs.critical_notify_device, 'name') %}
          {% if dev_name is string and (dev_name | trim) != '' %}
            {{ 'notify.mobile_app_' ~ ((dev_name | slugify) | replace('-', '_')) }}
          {% else %}
            {{ notify_service }}
          {% endif %}
        {% else %}
          {{ notify_service }}
        {% endif %}

  # ===== FLOW 1: NEED FRESH AIR =====
  - choose:
      - conditions:
          - "{{ reminder_triggered }}"
        sequence:
          - service: weather.get_forecasts
            target:
              entity_id: "{{ inputs.weather_entity }}"
            data:
              type: hourly
            response_variable: weather_forecast
            continue_on_error: true

          - variables:
              forecast_list: >
                {% set ent = inputs.weather_entity %}
                {% if weather_forecast is defined and weather_forecast is mapping and (ent in weather_forecast) %}
                  {% set payload = weather_forecast[ent] %}
                  {% if payload is mapping and ('forecast' in payload) and (payload['forecast'] is iterable) and (payload['forecast'] is not string) %}
                    {{ payload['forecast'][:6] }}
                  {% else %}
                    {{ [] }}
                  {% endif %}
                {% else %}
                  {{ [] }}
                {% endif %}

              rain_soon: >
                {% set ns = namespace(hit=false) %}
                {% for slot in forecast_list %}
                  {% if slot is mapping and ('condition' in slot) and (slot.condition in rain_states) %}
                    {% set ns.hit = true %}
                  {% endif %}
                {% endfor %}
                {{ ns.hit }}

              weather_blocked: "{{ rain_now or rain_soon }}"
              reminder_allowed: "{{ (not away_mode_active) and (not is_night) and reminder_triggered and (not weather_blocked) }}"

          - choose:
              - conditions:
                  - "{{ reminder_allowed }}"
                sequence:
                  - service: "{{ notify_service }}"
                    data:
                      title: "ü™ü Bitte kurz l√ºften"
                      message: >
                        Sto√ül√ºften empfohlen.
                        Grund: {{ reminder_reason if (reminder_reason | trim) != '' else 'Zeit-/Schwellwert-Trigger' }}.
                        Aktuelle Fenster: {{ open_windows_text }}.
                    continue_on_error: true

  # ===== FLOW 2: WINDOW OPENED -> TIMER -> ESCALATION =====
  - choose:
      - conditions:
          - "{{ window_opened_trigger }}"
        sequence:
          - delay:
              minutes: "{{ inputs.airing_duration }}"

          - variables:
              any_window_open_now: >
                {% if window_entities | length > 0 %}
                  {{ expand(window_entities) | selectattr('state', 'eq', 'on') | list | length > 0 }}
                {% else %}
                  false
                {% endif %}
              open_windows_now_text: >
                {% set ns = namespace(items=[]) %}
                {% for w in window_entities %}
                  {% if is_state(w, 'on') %}
                    {% set label = state_attr(w, 'friendly_name') if state_attr(w, 'friendly_name') is not none else w %}
                    {% set ns.items = ns.items + [label] %}
                  {% endif %}
                {% endfor %}
                {{ ns.items | join(', ') if ns.items | length > 0 else 'Fenster' }}

          - choose:
              - conditions:
                  - "{{ any_window_open_now }}"
                sequence:
                  - service: "{{ notify_service }}"
                    data:
                      title: "ü™ü Zeit zum Schlie√üen"
                      message: >
                        Die L√ºftungszeit ({{ inputs.airing_duration | int }} min) ist erreicht.
                        Bitte Fenster schlie√üen: {{ open_windows_now_text }}.
                    continue_on_error: true

          - delay:
              minutes: "{{ inputs.escalation_delay }}"

          - choose:
              - conditions:
                  - "{{ critical_service != '' }}"
                sequence:
                  - repeat:
                      while:
                        - condition: template
                          value_template: >
                            {% if window_entities | length > 0 %}
                              {{ expand(window_entities) | selectattr('state', 'eq', 'on') | list | length > 0 }}
                            {% else %}
                              false
                            {% endif %}
                      sequence:
                        - service: "{{ critical_service }}"
                          data:
                            title: "üö® CLOSE WINDOWS NOW!"
                            message: "{{ trigger_window_name }} ist noch offen. Bitte sofort schlie√üen!"
                            data:
                              push:
                                interruption-level: critical
                                sound:
                                  name: alarm.caf
                                  critical: 1
                                  volume: 1.0
                              ttl: 0
                              priority: high
                          continue_on_error: true
                        - delay:
                            minutes: 1

  # ===== FLOW 3: SAFETY (RAIN / AWAY MODE) =====
  - choose:
      - conditions:
          - "{{ trigger.id in ['safety_rain', 'safety_away_mode'] }}"
        sequence:
          - variables:
              safety_due_to_rain: "{{ trigger.id == 'safety_rain' }}"
              safety_due_to_away_mode: "{{ trigger.id == 'safety_away_mode' and away_mode_active }}"
              safety_should_alert: "{{ any_window_open and (safety_due_to_rain or safety_due_to_away_mode) }}"
              safety_reason: >
                {% if safety_due_to_rain %}
                  üåßÔ∏è Regen erkannt
                {% elif safety_due_to_away_mode %}
                  üè† Away Mode aktiviert
                {% else %}
                  ‚ö†Ô∏è Sicherheits-Event
                {% endif %}

          - choose:
              - conditions:
                  - "{{ safety_should_alert }}"
                  - "{{ critical_service != '' }}"
                sequence:
                  - service: "{{ critical_service }}"
                    data:
                      title: "‚ö†Ô∏è Rain/Left Home - CLOSE WINDOWS!"
                      message: "{{ safety_reason }}. Offene Fenster: {{ open_windows_text }}."
                      data:
                        push:
                          interruption-level: critical
                          sound:
                            name: alarm.caf
                            critical: 1
                            volume: 1.0
                        ttl: 0
                        priority: high
                    continue_on_error: true
