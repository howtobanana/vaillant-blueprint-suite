blueprint:
  name: "(Vaillant) Heizungssteuerung"
  description: |
    **Zentrale Heizungslogik f√ºr Vaillant-Systeme**

    Dieses Modul bildet das Herzst√ºck der Heizungssteuerung. Es koordiniert den Master-Thermostat und die Heizk√∂rperventile (TRVs) basierend auf physikalischem Bedarf, Wetterdaten und Sicherheitslogik.

    **Kern-Funktionen:**
    *   üõ°Ô∏è **Dynamic Safety:** Unterscheidet zwischen K√§lteeinbruch (Not-Aus) und Luftaustausch (Weiterheizen).
    *   üîó **Smart Follower:** Dynamische Offset-Steuerung f√ºr Nebenr√§ume (folgen dem Master).
    *   ‚ö° **Echtzeit-Reaktion:** Sofortige Anpassung bei Status√§nderungen ohne Latenz.
    *   üß† **Fail-Safe:** Mehrstufige Sicherheitslogik (Debounce, Frostschutz, 60min Time-Guard).

    **Das √ñkosystem:**
    Entwickelt f√ºr den Betrieb im Verbund mit:
    *   üìç `(Vaillant) Geofencing` (Anwesenheit & Eco).
    *   üí® `(Vaillant) L√ºftungs-Steuerung` (Luftaustausch & Feuchtigkeit).
    *   ‚ù§Ô∏è `(Vaillant) System-Diagnose` (Wartung & Batterien).

    **Voraussetzungen:**
    Erfordert die **myVaillant** Integration (HACS). Besonderer Dank an die Entwickler dieser Integration f√ºr die Bereitstellung der Schnittstelle.

    **Haftungsausschluss:**
    Dies ist ein privates Projekt. Der Autor ist kein zertifizierter Installateur. Die Nutzung erfolgt auf eigene Gefahr. F√ºr Sch√§den an der Anlage oder durch Fehlkonfiguration wird keine Haftung √ºbernommen.

    **Version:** 1.0 (Refactor) | **Autor:** BananaPower

  domain: automation
  source_url: https://raw.githubusercontent.com/howtobanana/vaillant-suite-blueprints/main/blueprints/vaillant_heizungs-steuerung.yaml
  author: "bananapower"

  input:
    section_global:
      name: "üåç Basisparameter"
      description: |

        Grundlegende Einstellungen f√ºr Wetterf√ºhler, Sommer-Logik, Abwesenheitsstatus und API-Limits.
        Diese Parameter definieren globale Grenzen und Fallback-Werte der Regelung.

      collapsed: false
      input:
        outdoor_temp_sensor:
          name: "üå°Ô∏è Au√üentemperatur"
          description: |

            Optionaler Au√üentemperatursensor f√ºr Sommermodus, Frostlogik und Wetterkompensation.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature
        summer_threshold:
          name: "üå°Ô∏è Sommer-Grenzwert (¬∞C)"
          description: |

            Schwellwert f√ºr den Sommer-Modus. Oberhalb dieses Werts wird Heizbetrieb reduziert.

          default: 18
          selector:
            number:
              min: 15
              max: 22
              step: 1
              unit_of_measurement: "¬∞C"
        summer_hysteresis:
          name: "‚ÜïÔ∏è Sommer-Hysterese (¬∞C)"
          description: |

            Verhindert schnelles Takten im Grenzbereich. Hysterese f√ºr den Sommer-Modus.

          default: 1.0
          selector:
            number:
              min: 0.5
              max: 3.0
              step: 0.5
              unit_of_measurement: "¬∞C"
        panic_mode_enabled:
          name: "üö® Panic Mode Helper (opt)"
          description: |

            Globaler Notfall-Schalter. Erzwingt Komfort-Temperatur bei Sensor-Ausfall.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: ""
          selector:
            entity:
              domain: input_boolean
        eco_temp_input:
          name: "üå°Ô∏è Eco-Temp Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Eco-Solltemperatur. √úberschreibt den Fixwert.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        eco_temp_fixed:
          name: "üå°Ô∏è Eco-Temp Fix (¬∞C)"
          description: |

            Fallback-Solltemperatur f√ºr Eco-Betrieb ohne Helper.

          default: 19
          selector:
            number:
              min: 17
              max: 21
              step: 0.5
              unit_of_measurement: "¬∞C"
        away_temp_input:
          name: "üå°Ô∏è Away-Temp Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Away-Solltemperatur. √úberschreibt den Fixwert.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        away_temp_fixed:
          name: "üå°Ô∏è Away-Temp Fix (¬∞C)"
          description: |

            Fallback-Solltemperatur f√ºr Abwesenheitsbetrieb ohne Helper.

          default: 16
          selector:
            number:
              min: 14
              max: 18
              step: 0.5
              unit_of_measurement: "¬∞C"

        away_mode_boolean:
          name: "Away-Mode Helper (input_boolean)"
          description: |

            Globaler Abwesenheits-Schalter. Aktiviert sofort den Away-Sollwert. Mehrere Entitys werden als ODER ausgewertet.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true
        max_changes_per_hour:
          name: "üîß Max √Ñnderungen/h"
          description: |

            Maximale Anzahl Master-Schreibvorg√§nge pro Stunde.
            Hohe Werte erlauben bei netzbetriebenen Ger√§ten nahezu sofortige Aktualisierungen.

          default: 12
          selector:
            number:
              min: 2
              max: 10
              step: 1

    section_master:
      name: "üè† Master-Raum"
      description: |

        Parameter f√ºr den f√ºhrenden Master-Raum und die zentrale Sollwertstrategie.
        Der Master-Thermostat ist die prim√§re Schnittstelle zur Heizungsanlage.

      collapsed: false
      input:
        master_climate:
          name: "‚ô®Ô∏è Master Thermostat (Pflicht)"
          description: |

            Erforderlicher Master-Thermostat. Prim√§res Zielsystem f√ºr Sollwertvorgaben.

          default: ""
          selector:
            entity:
              domain: climate
        master_last_write_helper:
          name: "üìù Master Last Write Tracker"
          description: |
            **Pflicht-Helper f√ºr API-Cooldown-Tracking.**

            **Typ:** `input_datetime` (mit Datum + Uhrzeit).

            Dieser Helper speichert den Zeitstempel des letzten erfolgreichen API-Writes an den Master-Thermostat.

            ‚ö†Ô∏è **NICHT manuell √§ndern!** Wird automatisch vom Blueprint verwaltet.

            **Erstellen in Home Assistant:**
            Einstellungen ‚Üí Ger√§te & Dienste ‚Üí Helfer ‚Üí Helfer erstellen ‚Üí Datum und/oder Uhrzeit ‚Üí Name: "Vaillant Master Last Write" ‚Üí Datum UND Uhrzeit aktivieren.
          selector:
            entity:
              domain: input_datetime
        master_comfort_input:
          name: "üå°Ô∏è Master Komfort Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Komfort-Solltemperatur des Master-Raums.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        master_comfort_fixed:
          name: "üå°Ô∏è Master Komfort Fix (¬∞C)"
          description: |

            Fallback-Komforttemperatur des Master-Raums ohne Helper.

          default: 20.5
          selector:
            number:
              min: 19
              max: 24
              step: 0.5
              unit_of_measurement: "¬∞C"
        master_schedule:
          name: "üóìÔ∏è Master Zeitplan"
          description: |

            Optionaler Zeitplan f√ºr den Komfortbetrieb im Master-Raum.

          default: ""
          selector:
            entity:
              domain: schedule
        master_presence_sensors:
          name: "üëÄ Master Pr√§senz"
          description: |

            Optionale Pr√§senzsensoren f√ºr bedarfsgef√ºhrten Komfortbetrieb im Master-Raum.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        presence_activation_delay:
          name: "‚è±Ô∏è Pr√§senz Aktivierung (min)"
          description: |

            Verz√∂gerung bis Pr√§senz als aktiv bewertet wird.

          default: 2
          selector:
            number:
              min: 0
              max: 10
              step: 1
              unit_of_measurement: "min"
        presence_deactivation_delay:
          name: "‚è±Ô∏è Pr√§senz Nachlauf (min)"
          description: |

            Nachlaufzeit bis R√ºckfall auf Eco nach letzter Pr√§senz.

          default: 30
          selector:
            number:
              min: 30
              max: 120
              step: 5
              unit_of_measurement: "min"
        enable_master_presence_priority:
          name: "üëë Master gewinnt bei Pr√§senz"
          description: |

            Aktiviert Vorrang des Master-Raums gegen√ºber isolierten R√§umen bei Pr√§senz.

          default: false
          selector:
            boolean:
        master_presence_priority_helper:
          name: "üß© Master-Priorit√§t Helper (opt)"
          description: |

            Optionaler Laufzeit-Override f√ºr Master-Priorit√§t. ON = Vorrang aktiv.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: ""
          selector:
            entity:
              domain: input_boolean
        master_smart_window:
          name: "üß† Master Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor. Wird logisch ODER mit dem Hardwarekontakt verkn√ºpft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        master_temp_sensor:
          name: "üå°Ô∏è Master Temperatursensor"
          description: |

            Optionaler externer Temperatursensor des Master-Raums.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature
        master_humidity_sensor:
          name: "üíß Master Feuchte"
          description: |

            Optionaler Luftfeuchtesensor f√ºr Feuchtekompensation im Master-Raum.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: humidity

    section_follower_1:
      name: "üîó Verbundener Raum 1 (z.B. Flur)"
      description: |

        Verbundener Raum folgt dem Master-Sollwert mit Offset.
        Der Raum erh√∂ht den Master-Sollwert nicht.

      collapsed: true
      input:
        follower1_enabled:
          name: "üîò Follower 1 Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Follower-Raum 1.

          default: false
          selector:
            boolean:
        follower1_name:
          name: "üìù Follower 1 Name (opt)"
          description: |

            Optionaler Anzeigename f√ºr UI und Protokollierung von Follower-Raum 1.

          default: ""
          selector:
            text:
        follower1_climate:
          name: "‚ô®Ô∏è Follower 1 TRV"
          description: |

            TRV/Thermostat f√ºr Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: climate
        follower1_offset:
          name: "‚ÜòÔ∏è Follower 1 Offset (¬∞C)"
          description: |

            Temperatur-Offset relativ zum Master-Sollwert f√ºr Follower-Raum 1. Negative Werte senken den Sollwert.

          default: -2.0
          selector:
            number:
              min: -3.0
              max: -0.5
              step: 0.5
              unit_of_measurement: "¬∞C"
        follower1_window:
          name: "ü™ü Follower 1 Fenster (opt)"
          description: |

            Optionaler Fensterkontakt f√ºr Sicherheitsabsenkung in Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        follower1_temp_sensor:
          name: "üå°Ô∏è Follower 1 Temperatursensor (opt)"
          description: |

            Optionaler externer Temperatursensor f√ºr Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_follower_2:
      name: "üîó Verbundener Raum 2 (z.B. WC)"
      description: |

        Verbundener Raum folgt dem Master-Sollwert mit Offset.
        Der Raum erh√∂ht den Master-Sollwert nicht.

      collapsed: true
      input:
        follower2_enabled:
          name: "üîò Follower 2 Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Follower-Raum 2.

          default: false
          selector:
            boolean:
        follower2_name:
          name: "üìù Follower 2 Name (opt)"
          description: |

            Optionaler Anzeigename f√ºr UI und Protokollierung von Follower-Raum 2.

          default: ""
          selector:
            text:
        follower2_climate:
          name: "‚ô®Ô∏è Follower 2 TRV"
          description: |

            TRV/Thermostat f√ºr Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: climate
        follower2_offset:
          name: "‚ÜòÔ∏è Follower 2 Offset (¬∞C)"
          description: |

            Temperatur-Offset relativ zum Master-Sollwert f√ºr Follower-Raum 2. Negative Werte senken den Sollwert.

          default: -2.0
          selector:
            number:
              min: -3.0
              max: -0.5
              step: 0.5
              unit_of_measurement: "¬∞C"
        follower2_window:
          name: "ü™ü Follower 2 Fenster (opt)"
          description: |

            Optionaler Fensterkontakt f√ºr Sicherheitsabsenkung in Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        follower2_temp_sensor:
          name: "üå°Ô∏è Follower 2 Temperatursensor (opt)"
          description: |

            Optionaler externer Temperatursensor f√ºr Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_room2:
      name: "üõèÔ∏è Raum 2"
      description: |

        Isolierter Raum mit eigener Komfortlogik √ºber Zeitplan und Pr√§senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room2_enabled:
          name: "üîò Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Raum 2.

          default: false
          selector:
            boolean:
        room2_climate:
          name: "‚ô®Ô∏è TRV"
          description: |

            TRV/Thermostat f√ºr Raum 2.

          default: ""
          selector:
            entity:
              domain: climate
        room2_comfort_input:
          name: "üå°Ô∏è Komfort Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Komfort-Solltemperatur in Raum 2.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room2_comfort_fixed:
          name: "üå°Ô∏è Komfort Fix (¬∞C)"
          description: |

            Fallback-Komforttemperatur in Raum 2 ohne Helper.

          default: 21.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "¬∞C"
        room2_schedule:
          name: "üóìÔ∏è Zeitplan"
          description: |

            Optionaler Zeitplan f√ºr Komfortbetrieb in Raum 2.

          default: ""
          selector:
            entity:
              domain: schedule
        room2_presence_sensors:
          name: "üëÄ Pr√§senz"
          description: |

            Optionale Pr√§senzsensoren f√ºr Komfortfreigabe in Raum 2.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room2_presence_delay:
          name: "‚è±Ô∏è Nachlauf (min)"
          description: |

            Nachlaufzeit bis R√ºckfall auf Eco in Raum 2.

          default: 30
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room2_window:
          name: "ü™ü Fenster"
          description: |

            Fensterkontakt in Raum 2 f√ºr Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room2_smart_window:
          name: "üß† Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 2. Wird mit Hardwarekontakt logisch ODER verkn√ºpft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room2_temp_sensor:
          name: "üå°Ô∏è Temperatursensor"
          description: |

            Optionaler externer Temperatursensor f√ºr Raum 2.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room3:
      name: "üíª Raum 3"
      description: |

        Isolierter Raum mit eigener Komfortlogik √ºber Zeitplan und Pr√§senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room3_enabled:
          name: "üîò Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Raum 3.

          default: false
          selector:
            boolean:
        room3_climate:
          name: "‚ô®Ô∏è TRV"
          description: |

            TRV/Thermostat f√ºr Raum 3.

          default: ""
          selector:
            entity:
              domain: climate
        room3_comfort_input:
          name: "üå°Ô∏è Komfort Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Komfort-Solltemperatur in Raum 3.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room3_comfort_fixed:
          name: "üå°Ô∏è Komfort Fix (¬∞C)"
          description: |

            Fallback-Komforttemperatur in Raum 3 ohne Helper.

          default: 20.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "¬∞C"
        room3_schedule:
          name: "üóìÔ∏è Zeitplan"
          description: |

            Optionaler Zeitplan f√ºr Komfortbetrieb in Raum 3.

          default: ""
          selector:
            entity:
              domain: schedule
        room3_presence_sensors:
          name: "üëÄ Pr√§senz"
          description: |

            Optionale Pr√§senzsensoren f√ºr Komfortfreigabe in Raum 3.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room3_presence_delay:
          name: "‚è±Ô∏è Nachlauf (min)"
          description: |

            Nachlaufzeit bis R√ºckfall auf Eco in Raum 3.

          default: 30
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room3_window:
          name: "ü™ü Fenster"
          description: |

            Fensterkontakt in Raum 3 f√ºr Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room3_smart_window:
          name: "üß† Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 3. Wird mit Hardwarekontakt logisch ODER verkn√ºpft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room3_temp_sensor:
          name: "üå°Ô∏è Temperatursensor"
          description: |

            Optionaler externer Temperatursensor f√ºr Raum 3.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room4:
      name: "üõÅ Raum 4"
      description: |

        Isolierter Raum mit eigener Komfortlogik √ºber Zeitplan und Pr√§senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room4_enabled:
          name: "üîò Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Raum 4.

          default: false
          selector:
            boolean:
        room4_climate:
          name: "‚ô®Ô∏è TRV"
          description: |

            TRV/Thermostat f√ºr Raum 4.

          default: ""
          selector:
            entity:
              domain: climate
        room4_comfort_input:
          name: "üå°Ô∏è Komfort Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Komfort-Solltemperatur in Raum 4.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room4_comfort_fixed:
          name: "üå°Ô∏è Komfort Fix (¬∞C)"
          description: |

            Fallback-Komforttemperatur in Raum 4 ohne Helper.

          default: 22.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "¬∞C"
        room4_schedule:
          name: "üóìÔ∏è Zeitplan"
          description: |

            Optionaler Zeitplan f√ºr Komfortbetrieb in Raum 4.

          default: ""
          selector:
            entity:
              domain: schedule
        room4_presence_sensors:
          name: "üëÄ Pr√§senz"
          description: |

            Optionale Pr√§senzsensoren f√ºr Komfortfreigabe in Raum 4.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room4_presence_delay:
          name: "‚è±Ô∏è Nachlauf (min)"
          description: |

            Nachlaufzeit bis R√ºckfall auf Eco in Raum 4.

          default: 20
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room4_window:
          name: "ü™ü Fenster"
          description: |

            Fensterkontakt in Raum 4 f√ºr Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room4_smart_window:
          name: "üß† Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 4. Wird mit Hardwarekontakt logisch ODER verkn√ºpft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room4_temp_sensor:
          name: "üå°Ô∏è Temperatursensor"
          description: |

            Optionaler externer Temperatursensor f√ºr Raum 4.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room5:
      name: "üç≥ Raum 5"
      description: |

        Isolierter Raum mit eigener Komfortlogik √ºber Zeitplan und Pr√§senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room5_enabled:
          name: "üîò Aktiv"
          description: |

            Aktiviert die Regelung f√ºr Raum 5.

          default: false
          selector:
            boolean:
        room5_climate:
          name: "‚ô®Ô∏è TRV"
          description: |

            TRV/Thermostat f√ºr Raum 5.

          default: ""
          selector:
            entity:
              domain: climate
        room5_comfort_input:
          name: "üå°Ô∏è Komfort Helper (opt)"
          description: |

            Optionaler Helper f√ºr die Komfort-Solltemperatur in Raum 5.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room5_comfort_fixed:
          name: "üå°Ô∏è Komfort Fix (¬∞C)"
          description: |

            Fallback-Komforttemperatur in Raum 5 ohne Helper.

          default: 21.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "¬∞C"
        room5_schedule:
          name: "üóìÔ∏è Zeitplan"
          description: |

            Optionaler Zeitplan f√ºr Komfortbetrieb in Raum 5.

          default: ""
          selector:
            entity:
              domain: schedule
        room5_presence_sensors:
          name: "üëÄ Pr√§senz"
          description: |

            Optionale Pr√§senzsensoren f√ºr Komfortfreigabe in Raum 5.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room5_presence_delay:
          name: "‚è±Ô∏è Nachlauf (min)"
          description: |

            Nachlaufzeit bis R√ºckfall auf Eco in Raum 5.

          default: 45
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room5_window:
          name: "ü™ü Fenster"
          description: |

            Fensterkontakt in Raum 5 f√ºr Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room5_smart_window:
          name: "üß† Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 5. Wird mit Hardwarekontakt logisch ODER verkn√ºpft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room5_temp_sensor:
          name: "üå°Ô∏è Temperatursensor"
          description: |

            Optionaler externer Temperatursensor f√ºr Raum 5.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_smart_functions:
      name: "üß† Regelungsparameter & Smarte Funktionen"
      description: |

        Feinparameter f√ºr Sicherheitsabsenkung, Hysterese und adaptive Sollwertlogik.
        Diese Einstellungen steuern Reaktionsgeschwindigkeit und Stabilit√§t der Regelung.

      collapsed: true
      input:
        min_trv_temp:
          name: "‚ô®Ô∏è TRV Minimum (¬∞C)"
          description: |

            Mindest-Solltemperatur f√ºr Frostschutz und Sicherheitsabsenkung.

          default: 12
          selector:
            number:
              min: 5
              max: 15
              step: 0.5
              unit_of_measurement: "¬∞C"
        window_heat_delay:
          name: "‚è±Ô∏è Fenster-Delay (min)"
          description: |

            Fallback-Zeitlimit bei offenem Fenster bis zur Sicherheitsabsenkung.

          default: 15
          selector:
            number:
              min: 5
              max: 30
              step: 5
              unit_of_measurement: "min"
        smart_drop_threshold:
          name: "üìâ Smart-Drop Schwelle (¬∞C)"
          description: |

            Temperatursturz-Erkennung. Schaltet Heizung ab, wenn Ist-Wert um X ¬∞C unter Soll-Wert f√§llt.

          default: 2.0
          selector:
            number:
              min: 0.0
              max: 5.0
              step: 0.5
              unit_of_measurement: "¬∞C"
        hysteresis:
          name: "‚öôÔ∏è Hysterese (¬∞C)"
          description: |

            Mindestabweichung zwischen aktuellem und neuem Sollwert vor Schreibvorgang.

          default: 0.6
          selector:
            number:
              min: 0.1
              max: 1.0
              step: 0.1
              unit_of_measurement: "¬∞C"
        enable_weather_compensation:
          name: "üå¶Ô∏è Wetter-Kompensation aktiv"
          description: |

            Aktiviert lineare Sollwertanhebung bei niedriger Au√üentemperatur.

          default: false
          selector:
            boolean:
        enable_humidity_compensation:
          name: "üîò Feuchte-Kompensation"
          description: |

            Aktiviert Sollwertabsenkung bei hoher Luftfeuchte im Master-Raum.

          default: false
          selector:
            boolean:


mode: restart

trigger:
  - platform: time_pattern
    minutes: "/15"
    id: main_loop

  - platform: state
    entity_id: !input master_presence_sensors
    id: master_presence_change

  - platform: state
    entity_id: !input room2_presence_sensors
    id: room2_presence_change

  - platform: state
    entity_id: !input room3_presence_sensors
    id: room3_presence_change

  - platform: state
    entity_id: !input room4_presence_sensors
    id: room4_presence_change

  - platform: state
    entity_id: !input room5_presence_sensors
    id: room5_presence_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input master_schedule
    id: master_schedule_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room2_schedule
    id: room2_schedule_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room3_schedule
    id: room3_schedule_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room4_schedule
    id: room4_schedule_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room5_schedule
    id: room5_schedule_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room2_window
    id: room2_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room3_window
    id: room3_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room4_window
    id: room4_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room5_window
    id: room5_window_change

  # Smart-Window Trigger (Master, optional-safe)
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input master_smart_window
    id: master_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input master_smart_window
    id: master_smart_window_change

  # Smart-Window Trigger (Rooms, optional-safe)
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input room2_smart_window
    id: room2_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input room2_smart_window
    id: room2_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input room3_smart_window
    id: room3_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input room3_smart_window
    id: room3_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input room4_smart_window
    id: room4_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input room4_smart_window
    id: room4_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input room5_smart_window
    id: room5_smart_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input room5_smart_window
    id: room5_smart_window_change

  # Follower-Window Trigger (optional-safe)
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input follower1_window
    id: follower1_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input follower1_window
    id: follower1_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'on') }}"
    variables:
      entity: !input follower2_window
    id: follower2_window_change
  - platform: template
    value_template: "{{ entity != '' and is_state(entity, 'off') }}"
    variables:
      entity: !input follower2_window
    id: follower2_window_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input eco_temp_input
    id: eco_temp_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input away_temp_input
    id: away_temp_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input master_comfort_input
    id: master_comfort_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room2_comfort_input
    id: room2_comfort_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room3_comfort_input
    id: room3_comfort_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room4_comfort_input
    id: room4_comfort_input_change

  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input room5_comfort_input
    id: room5_comfort_input_change

  - platform: state
    entity_id: !input away_mode_boolean
    id: awaymodechange

condition: []

action:
  - variables:
      # ===== GROUP 1: INPUTS & HELPERS =====
      inputs:
        outdoor_temp_sensor: !input outdoor_temp_sensor
        summer_threshold: !input summer_threshold
        summer_hysteresis: !input summer_hysteresis
        panic_mode_enabled: !input panic_mode_enabled
        eco_temp_input: !input eco_temp_input
        eco_temp_fixed: !input eco_temp_fixed
        away_temp_input: !input away_temp_input
        away_temp_fixed: !input away_temp_fixed
        away_mode_boolean: !input away_mode_boolean
        min_trv_temp: !input min_trv_temp
        window_heat_delay: !input window_heat_delay
        smart_drop_threshold: !input smart_drop_threshold
        hysteresis: !input hysteresis
        max_changes_per_hour: !input max_changes_per_hour
        enable_weather_compensation: !input enable_weather_compensation
        enable_humidity_compensation: !input enable_humidity_compensation
        master_climate: !input master_climate
        master_last_write_helper: !input master_last_write_helper
        master_comfort_input: !input master_comfort_input
        master_comfort_fixed: !input master_comfort_fixed
        master_schedule: !input master_schedule
        master_presence_sensors: !input master_presence_sensors
        presence_activation_delay: !input presence_activation_delay
        presence_deactivation_delay: !input presence_deactivation_delay
        enable_master_presence_priority: !input enable_master_presence_priority
        master_presence_priority_helper: !input master_presence_priority_helper
        master_smart_window: !input master_smart_window
        master_temp_sensor: !input master_temp_sensor
        master_humidity_sensor: !input master_humidity_sensor
        room2_enabled: !input room2_enabled
        room2_climate: !input room2_climate
        room2_comfort_input: !input room2_comfort_input
        room2_comfort_fixed: !input room2_comfort_fixed
        room2_schedule: !input room2_schedule
        room2_presence_sensors: !input room2_presence_sensors
        room2_presence_delay: !input room2_presence_delay
        room2_window: !input room2_window
        room2_smart_window: !input room2_smart_window
        room2_temp_sensor: !input room2_temp_sensor
        room3_enabled: !input room3_enabled
        room3_climate: !input room3_climate
        room3_comfort_input: !input room3_comfort_input
        room3_comfort_fixed: !input room3_comfort_fixed
        room3_schedule: !input room3_schedule
        room3_presence_sensors: !input room3_presence_sensors
        room3_presence_delay: !input room3_presence_delay
        room3_window: !input room3_window
        room3_smart_window: !input room3_smart_window
        room3_temp_sensor: !input room3_temp_sensor
        room4_enabled: !input room4_enabled
        room4_climate: !input room4_climate
        room4_comfort_input: !input room4_comfort_input
        room4_comfort_fixed: !input room4_comfort_fixed
        room4_schedule: !input room4_schedule
        room4_presence_sensors: !input room4_presence_sensors
        room4_presence_delay: !input room4_presence_delay
        room4_window: !input room4_window
        room4_smart_window: !input room4_smart_window
        room4_temp_sensor: !input room4_temp_sensor
        room5_enabled: !input room5_enabled
        room5_climate: !input room5_climate
        room5_comfort_input: !input room5_comfort_input
        room5_comfort_fixed: !input room5_comfort_fixed
        room5_schedule: !input room5_schedule
        room5_presence_sensors: !input room5_presence_sensors
        room5_presence_delay: !input room5_presence_delay
        room5_window: !input room5_window
        room5_smart_window: !input room5_smart_window
        room5_temp_sensor: !input room5_temp_sensor
        follower1_enabled: !input follower1_enabled
        follower1_name: !input follower1_name
        follower1_climate: !input follower1_climate
        follower1_offset: !input follower1_offset
        follower1_window: !input follower1_window
        follower1_temp_sensor: !input follower1_temp_sensor
        follower2_enabled: !input follower2_enabled
        follower2_name: !input follower2_name
        follower2_climate: !input follower2_climate
        follower2_offset: !input follower2_offset
        follower2_window: !input follower2_window
        follower2_temp_sensor: !input follower2_temp_sensor
      helper_input_settle_seconds: 30
      trigger_id_safe: >
        {% if trigger is defined and trigger is not none and trigger.id is defined %}
          {{ trigger.id }}
        {% else %}

        {% endif %}
      helper_input_trigger: >
        {{ trigger_id_safe in [
          'eco_temp_input_change',
          'away_temp_input_change',
          'master_comfort_input_change',
          'room2_comfort_input_change',
          'room3_comfort_input_change',
          'room4_comfort_input_change',
          'room5_comfort_input_change',
          'awaymodechange'
        ] }}
      helper_input_trigger_entity: >
        {% if not helper_input_trigger %}

        {% elif trigger is defined and trigger is not none and trigger.event is defined and trigger.event.data is defined and trigger.event.data.entity_id is defined %}
          {{ trigger.event.data.entity_id }}
        {% elif trigger is defined and trigger is not none and trigger.entity_id is defined and trigger.entity_id is not none %}
          {{ trigger.entity_id }}
        {% else %}

        {% endif %}
      helper_input_trigger_ts: >
        {% if not helper_input_trigger %}
          {{ as_timestamp(now()) }}
        {% elif trigger is defined and trigger is not none and trigger.event is defined and trigger.event.time_fired is defined %}
          {{ as_timestamp(trigger.event.time_fired, as_timestamp(now())) }}
        {% elif trigger is defined and trigger is not none and trigger.to_state is defined and trigger.to_state is not none and trigger.to_state.last_changed is defined %}
          {{ as_timestamp(trigger.to_state.last_changed, as_timestamp(now())) }}
        {% else %}
          {{ as_timestamp(now()) }}
        {% endif %}

      # ===== GROUP 2: ROOM STATES =====
      master_schedule_active: >
        {% if inputs.master_schedule != "" %}
          {{ is_state(inputs.master_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      master_presence_detected: >
        {% if inputs.master_presence_sensors | length == 0 %}
          {{ false }}
        {% else %}
          {% set sensors = expand(inputs.master_presence_sensors) | selectattr('last_changed', 'defined') | list %}
          {% if sensors | length == 0 %}
            {{ false }}
          {% else %}
            {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
            {% set ns = namespace(active=false) %}

            {# Aktivierung: Sofort wenn ON + >=2 Min #}
            {% for s in sensors %}
              {% if s.state == 'on' %}
                {% set s_changed_dt = s.last_changed | as_datetime %}
                {% if s_changed_dt is not none %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                  {% set on_duration = now_ts - changed_ts %}
                  {% if on_duration >= (inputs.presence_activation_delay | float(0) * 60) %}
                    {% set ns.active = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {# Wenn aktiv -> true #}
            {% if ns.active %}
              {{ true }}
            {# Wenn nicht aktiv, alle OFF -> Nachlauf pr√ºfen (PER SENSOR!) #}
            {% elif not any_on %}
              {% set recently_off = namespace(found=false) %}
              {% for s in sensors %}
                {% if s.state == 'off' %}
                  {% set s_changed_dt = s.last_changed | as_datetime %}
                  {% if s_changed_dt is not none %}
                    {% set now_ts = as_timestamp(now()) | float(0) %}
                    {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                    {% set off_duration = now_ts - changed_ts %}
                    {# Nur Nachlauf wenn <30 Min OFF #}
                    {% if off_duration < (inputs.presence_deactivation_delay | float(0) * 60) %}
                      {% set recently_off.found = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ recently_off.found }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% endif %}
      room2_schedule_active_for_demand: >
        {% if inputs.room2_enabled and inputs.room2_schedule != "" %}
          {{ is_state(inputs.room2_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room2_presence_for_demand: >
        {% if not inputs.room2_enabled or (inputs.room2_presence_sensors | length == 0) %}
          {{ false }}
        {% else %}
          {% set sensors = expand(inputs.room2_presence_sensors) | selectattr('last_changed', 'defined') | list %}
          {% if sensors | length == 0 %}
            {{ false }}
          {% else %}
            {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
            {% set ns = namespace(active=false) %}

            {% for s in sensors %}
              {% if s.state == 'on' %}
                {% set s_changed_dt = s.last_changed | as_datetime %}
                {% if s_changed_dt is not none %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                  {% set on_duration = now_ts - changed_ts %}
                  {% if on_duration >= (inputs.room2_presence_delay | float(0) * 60) %}
                    {% set ns.active = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if ns.active %}
              {{ true }}
            {% elif not any_on %}
              {% set recently_off = namespace(found=false) %}
              {% for s in sensors %}
                {% if s.state == 'off' %}
                  {% set s_changed_dt = s.last_changed | as_datetime %}
                  {% if s_changed_dt is not none %}
                    {% set now_ts = as_timestamp(now()) | float(0) %}
                    {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                    {% set off_duration = now_ts - changed_ts %}
                    {% if off_duration < (inputs.room2_presence_delay | float(0) * 60) %}
                      {% set recently_off.found = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ recently_off.found }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% endif %}
      room3_schedule_active_for_demand: >
        {% if inputs.room3_enabled and inputs.room3_schedule != "" %}
          {{ is_state(inputs.room3_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room3_presence_for_demand: >
        {% if not inputs.room3_enabled or (inputs.room3_presence_sensors | length == 0) %}
          {{ false }}
        {% else %}
          {% set sensors = expand(inputs.room3_presence_sensors) | selectattr('last_changed', 'defined') | list %}
          {% if sensors | length == 0 %}
            {{ false }}
          {% else %}
            {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
            {% set ns = namespace(active=false) %}

            {% for s in sensors %}
              {% if s.state == 'on' %}
                {% set s_changed_dt = s.last_changed | as_datetime %}
                {% if s_changed_dt is not none %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                  {% set on_duration = now_ts - changed_ts %}
                  {% if on_duration >= (inputs.room3_presence_delay | float(0) * 60) %}
                    {% set ns.active = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if ns.active %}
              {{ true }}
            {% elif not any_on %}
              {% set recently_off = namespace(found=false) %}
              {% for s in sensors %}
                {% if s.state == 'off' %}
                  {% set s_changed_dt = s.last_changed | as_datetime %}
                  {% if s_changed_dt is not none %}
                    {% set now_ts = as_timestamp(now()) | float(0) %}
                    {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                    {% set off_duration = now_ts - changed_ts %}
                    {% if off_duration < (inputs.room3_presence_delay | float(0) * 60) %}
                      {% set recently_off.found = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ recently_off.found }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% endif %}
      room4_schedule_active_for_demand: >
        {% if inputs.room4_enabled and inputs.room4_schedule != "" %}
          {{ is_state(inputs.room4_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room4_presence_for_demand: >
        {% if not inputs.room4_enabled or (inputs.room4_presence_sensors | length == 0) %}
          {{ false }}
        {% else %}
          {% set sensors = expand(inputs.room4_presence_sensors) | selectattr('last_changed', 'defined') | list %}
          {% if sensors | length == 0 %}
            {{ false }}
          {% else %}
            {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
            {% set ns = namespace(active=false) %}

            {% for s in sensors %}
              {% if s.state == 'on' %}
                {% set s_changed_dt = s.last_changed | as_datetime %}
                {% if s_changed_dt is not none %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                  {% set on_duration = now_ts - changed_ts %}
                  {% if on_duration >= (inputs.room4_presence_delay | float(0) * 60) %}
                    {% set ns.active = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if ns.active %}
              {{ true }}
            {% elif not any_on %}
              {% set recently_off = namespace(found=false) %}
              {% for s in sensors %}
                {% if s.state == 'off' %}
                  {% set s_changed_dt = s.last_changed | as_datetime %}
                  {% if s_changed_dt is not none %}
                    {% set now_ts = as_timestamp(now()) | float(0) %}
                    {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                    {% set off_duration = now_ts - changed_ts %}
                    {% if off_duration < (inputs.room4_presence_delay | float(0) * 60) %}
                      {% set recently_off.found = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ recently_off.found }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% endif %}
      room5_schedule_active_for_demand: >
        {% if inputs.room5_enabled and inputs.room5_schedule != "" %}
          {{ is_state(inputs.room5_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room5_presence_for_demand: >
        {% if not inputs.room5_enabled or (inputs.room5_presence_sensors | length == 0) %}
          {{ false }}
        {% else %}
          {% set sensors = expand(inputs.room5_presence_sensors) | selectattr('last_changed', 'defined') | list %}
          {% if sensors | length == 0 %}
            {{ false }}
          {% else %}
            {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
            {% set ns = namespace(active=false) %}

            {% for s in sensors %}
              {% if s.state == 'on' %}
                {% set s_changed_dt = s.last_changed | as_datetime %}
                {% if s_changed_dt is not none %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                  {% set on_duration = now_ts - changed_ts %}
                  {% if on_duration >= (inputs.room5_presence_delay | float(0) * 60) %}
                    {% set ns.active = true %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {% if ns.active %}
              {{ true }}
            {% elif not any_on %}
              {% set recently_off = namespace(found=false) %}
              {% for s in sensors %}
                {% if s.state == 'off' %}
                  {% set s_changed_dt = s.last_changed | as_datetime %}
                  {% if s_changed_dt is not none %}
                    {% set now_ts = as_timestamp(now()) | float(0) %}
                    {% set changed_ts = as_timestamp(s_changed_dt) | float(0) %}
                    {% set off_duration = now_ts - changed_ts %}
                    {% if off_duration < (inputs.room5_presence_delay | float(0) * 60) %}
                      {% set recently_off.found = true %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}
              {{ recently_off.found }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% endif %}
      master_window_sensor_configured: >
        {{ inputs.master_smart_window != '' }}
      master_window_open: >
        {{ is_state(inputs.master_smart_window, 'on') if inputs.master_smart_window != '' else false }}
      master_window_open_too_long: >
        {% if master_window_sensor_configured and (master_window_open | bool(false)) %}
          {% if inputs.master_smart_window != '' and is_state(inputs.master_smart_window, 'on') %}
            {% set win_state = expand([inputs.master_smart_window]) | first %}
          {% else %}
            {% set win_state = none %}
          {% endif %}
          {% set now_ts = as_timestamp(now()) %}
          {% if win_state is not none and win_state.last_changed is defined and win_state.last_changed is not none %}
            {% set opened_ts = as_timestamp(win_state.last_changed, now_ts) %}
            {% set timer_expired = (now_ts - opened_ts) >= ((inputs.window_heat_delay | float(0)) * 60) %}
          {% else %}
            {% set timer_expired = false %}
          {% endif %}
          {% if inputs.master_temp_sensor != '' %}
            {% if inputs.master_climate != '' %}
              {% set current_temp = states(inputs.master_temp_sensor) | float(state_attr(inputs.master_climate, 'current_temperature') | float(21)) %}
            {% else %}
              {% set current_temp = states(inputs.master_temp_sensor) | float(21) %}
            {% endif %}
          {% elif inputs.master_climate != '' %}
            {% set current_temp = state_attr(inputs.master_climate, 'current_temperature') | float(21) %}
          {% else %}
            {% set current_temp = 21 %}
          {% endif %}
          {% if inputs.master_climate != '' %}
            {% set target_temp = state_attr(inputs.master_climate, 'temperature') | float(21) %}
          {% else %}
            {% set target_temp = master_target_temp | float(21) %}
          {% endif %}
          {% set drop_threshold = inputs.smart_drop_threshold | float(2.0) %}
          {% set temp_dropped = (drop_threshold <= 0) or (current_temp < (target_temp - drop_threshold)) %}
          {{ temp_dropped or timer_expired }}
        {% else %}
          {{ false }}
        {% endif %}
      master_window_recently_closed: >
        {% if not (master_window_sensor_configured | bool(false)) %}
          {{ false }}
        {% elif trigger is defined and trigger is not none and trigger.id is defined and trigger.id == 'master_smart_window_change' %}
          {% if trigger.to_state is defined and trigger.to_state is not none and trigger.from_state is defined and trigger.from_state is not none %}
            {{ (trigger.from_state.state == 'on') and (trigger.to_state.state == 'off') }}
          {% else %}
            {% set now_ts = as_timestamp(now(), 0) %}
            {% set ns = namespace(last_change_ts=0) %}
            {% if inputs.master_smart_window != '' and is_state(inputs.master_smart_window, 'off') %}
              {% set sw = expand([inputs.master_smart_window]) | first %}
              {% if sw is not none and sw.last_changed is defined and sw.last_changed is not none %}
                {% set sw_ts = as_timestamp(sw.last_changed, 0) | float(0) %}
                {% if sw_ts > 946684800 and sw_ts <= now_ts %}
                  {% set ns.last_change_ts = [ns.last_change_ts, sw_ts] | max %}
                {% endif %}
              {% endif %}
            {% endif %}
            {% if ns.last_change_ts > 0 %}
              {{ (now_ts - ns.last_change_ts) < ((inputs.window_heat_delay | float(0)) * 60) }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% else %}
          {{ false }}
        {% endif %}

      # ===== GROUP 3: DEMAND CALCULATION =====
      eco_temp: >
        {% if inputs.eco_temp_input != "" %}
          {{ states(inputs.eco_temp_input) | float(inputs.eco_temp_fixed) }}
        {% else %}
          {{ inputs.eco_temp_fixed }}
        {% endif %}
      away_temp: >
        {% if inputs.away_temp_input != "" %}
          {{ states(inputs.away_temp_input) | float(inputs.away_temp_fixed) }}
        {% else %}
          {{ inputs.away_temp_fixed }}
        {% endif %}
      master_comfort_temp: >
        {% if inputs.master_comfort_input != "" %}
          {{ states(inputs.master_comfort_input) | float(inputs.master_comfort_fixed) }}
        {% else %}
          {{ inputs.master_comfort_fixed }}
        {% endif %}
      room2_comfort_temp_for_demand: >
        {% if inputs.room2_comfort_input != "" %}
          {{ states(inputs.room2_comfort_input) | float(inputs.room2_comfort_fixed) }}
        {% else %}
          {{ inputs.room2_comfort_fixed }}
        {% endif %}
      room3_comfort_temp_for_demand: >
        {% if inputs.room3_comfort_input != "" %}
          {{ states(inputs.room3_comfort_input) | float(inputs.room3_comfort_fixed) }}
        {% else %}
          {{ inputs.room3_comfort_fixed }}
        {% endif %}
      room4_comfort_temp_for_demand: >
        {% if inputs.room4_comfort_input != "" %}
          {{ states(inputs.room4_comfort_input) | float(inputs.room4_comfort_fixed) }}
        {% else %}
          {{ inputs.room4_comfort_fixed }}
        {% endif %}
      room5_comfort_temp_for_demand: >
        {% if inputs.room5_comfort_input != "" %}
          {{ states(inputs.room5_comfort_input) | float(inputs.room5_comfort_fixed) }}
        {% else %}
          {{ inputs.room5_comfort_fixed }}
        {% endif %}
      master_demand: >
        {% if master_schedule_active or master_presence_detected %}
          {{ master_comfort_temp }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room2_demand: >
        {% if inputs.room2_enabled and ((room2_schedule_active_for_demand | bool(false)) or (room2_presence_for_demand | bool(false))) %}
          {{ room2_comfort_temp_for_demand }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room3_demand: >
        {% if inputs.room3_enabled and ((room3_schedule_active_for_demand | bool(false)) or (room3_presence_for_demand | bool(false))) %}
          {{ room3_comfort_temp_for_demand }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room4_demand: >
        {% if inputs.room4_enabled and ((room4_schedule_active_for_demand | bool(false)) or (room4_presence_for_demand | bool(false))) %}
          {{ room4_comfort_temp_for_demand }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room5_demand: >
        {% if inputs.room5_enabled and ((room5_schedule_active_for_demand | bool(false)) or (room5_presence_for_demand | bool(false))) %}
          {{ room5_comfort_temp_for_demand }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      global_max_demand: >
        {{ [
          master_demand | float(eco_temp),
          room2_demand | float(eco_temp),
          room3_demand | float(eco_temp),
          room4_demand | float(eco_temp),
          room5_demand | float(eco_temp)
        ] | max }}

      # ===== GROUP 4: TARGET CALCULATION =====
      away_mode_helper_set: "{{ inputs.away_mode_boolean | length > 0 }}"
      away_mode_entity_on: >
        {% if away_mode_helper_set %}
          {% set ns = namespace(active=false) %}
          {% for ent in inputs.away_mode_boolean %}
            {% if ent is string and ent != '' and is_state(ent, 'on') %}
              {% set ns.active = true %}
            {% endif %}
          {% endfor %}
          {{ ns.active | bool(false) }}
        {% else %}
          {{ false }}
        {% endif %}
      panic_mode_active: >
        {% if inputs.panic_mode_enabled != '' %}
          {{ is_state(inputs.panic_mode_enabled, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      away_mode_should_be_active: false
      master_target_temp: >
        {% if panic_mode_active | bool(false) %}
          {{ master_comfort_temp }}
        {% elif (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
          {{ away_temp }}
        {% else %}
          {{ global_max_demand }}
        {% endif %}
      master_humidity: >
        {% if inputs.master_humidity_sensor != "" %}
          {{ states(inputs.master_humidity_sensor) | float(50) }}
        {% else %}
          50
        {% endif %}
      humidity_compensation_active: >
        {{ inputs.enable_humidity_compensation and master_humidity > 60 and master_humidity < 65 }}
      master_target_with_humidity: >
        {% if humidity_compensation_active %}
          {{ master_target_temp - 0.5 }}
        {% else %}
          {{ master_target_temp }}
        {% endif %}

      # ===== GROUP 5: SAFETY & STATUS =====
      outdoor_temp_sensor_configured: >
        {{ inputs.outdoor_temp_sensor != '' }}
      outdoor_temp: >
        {% set raw = states(inputs.outdoor_temp_sensor) if outdoor_temp_sensor_configured else '' %}
        {% if outdoor_temp_sensor_configured and raw not in ['unknown', 'unavailable', 'none', ''] %}
          {{ raw | float(0) }}
        {% else %}
          0
        {% endif %}
      outdoor_temp_valid: >
        {% set raw = states(inputs.outdoor_temp_sensor) if outdoor_temp_sensor_configured else '' %}
        {{ outdoor_temp_sensor_configured and (raw not in ['unknown', 'unavailable', 'none', '']) }}
      summer_mode: >
        {% if outdoor_temp_valid %}
          {% set current_outdoor = outdoor_temp | float(0) %}
          {% set threshold_on = inputs.summer_threshold | float(18) %}
          {% set threshold_off = threshold_on - (inputs.summer_hysteresis | float(1.0)) %}
          {% set master_set = state_attr(inputs.master_climate, 'temperature') | float(999) if inputs.master_climate != '' else 999 %}
          {% set master_min = state_attr(inputs.master_climate, 'min_temp') | float(inputs.min_trv_temp | float(12)) if inputs.master_climate != '' else (inputs.min_trv_temp | float(12)) %}
          {% set summer_state_guess = inputs.master_climate != '' and (master_set <= (master_min + 0.2)) %}
          {% if current_outdoor > threshold_on %}
            {{ true }}
          {% elif current_outdoor < threshold_off %}
            {{ false }}
          {% else %}
            {{ summer_state_guess }}
          {% endif %}
        {% else %}
          {{ false }}
        {% endif %}
      window_reheat_blocked: "{{ (master_window_recently_closed | bool(false)) and (outdoor_temp_valid | bool(false)) and ((outdoor_temp | float(0)) >= 5) }}"
      master_target_final: >
        {% if master_window_open_too_long or window_reheat_blocked %}
          {{ inputs.min_trv_temp }}
        {% else %}
          {{ master_target_with_humidity }}
        {% endif %}
      master_climate_available: >
        {{ inputs.master_climate != "" and states(inputs.master_climate) not in ['unavailable', 'unknown'] }}
      master_sensor_available: "{{ master_climate_available }}"

      # ===== GROUP 6: WRITE LOGIC FLAGS =====
      safe_mode_blocking: false
  # ===== STEP 0.01: HELPER INPUT DEBOUNCE =====
  - choose:
      - conditions:
          - "{{ helper_input_trigger }}"
        sequence:
          - delay:
              seconds: "{{ helper_input_settle_seconds }}"
          - choose:
              - conditions:
                  - "{{ helper_input_trigger_entity != '' }}"
                  - >
                    {% set so = expand([helper_input_trigger_entity]) | first %}
                    {% if so is not none and so.last_changed is defined %}
                      {{ as_timestamp(so.last_changed, 0) > ((helper_input_trigger_ts | float(0)) + 0.5) }}
                    {% else %}
                      {{ false }}
                    {% endif %}
                sequence:
                  - stop: "Neuere Helper-√Ñnderung erkannt - veralteten Lauf beendet."

    # ========== ROOM 2 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room2_enabled }}"
        sequence:
          - variables:
              room2_schedule_active: >
                {% if inputs.room2_schedule != "" %}
                  {{ is_state(inputs.room2_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room2_presence: >
                {% if inputs.room2_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room2_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room2_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room2_window_open: >
                {{ (is_state(inputs.room2_window, 'on') if inputs.room2_window != '' else false) or (is_state(inputs.room2_smart_window, 'on') if inputs.room2_smart_window != '' else false) }}
              room2_comfort_temp: >
                {% if inputs.room2_comfort_input != "" %}
                  {{ states(inputs.room2_comfort_input) | float(inputs.room2_comfort_fixed) }}
                {% else %}
                  {{ inputs.room2_comfort_fixed }}
                {% endif %}
              room2_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input %}
                  {{ room2_comfort_temp }}
                {% elif room2_schedule_active or room2_presence %}
                  {{ room2_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room2_final_temp: >
                {% if room2_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room2_schedule_active or room2_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room2_target_temp }}
                {% endif %}
              room2_climate_state: >
                {% if inputs.room2_climate != "" %}
                  {{ states(inputs.room2_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room2_climate_available: >
                {{ inputs.room2_climate != '' and states(inputs.room2_climate) not in ['unknown', 'unavailable'] }}
              room2_current_setpoint: >
                {% if room2_climate_available %}
                  {{ state_attr(inputs.room2_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room2_current_temp: >
                {% if inputs.room2_temp_sensor != "" %}
                  {% if room2_climate_available %}
                    {{ states(inputs.room2_temp_sensor) | float(state_attr(inputs.room2_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room2_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room2_climate_available %}
                  {{ state_attr(inputs.room2_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room2_temp_diff: >
                {{ (room2_final_temp - room2_current_setpoint) | abs }}
              room2_setpoint_threshold: 0.1
              force_room2_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room2_climate != '' and states(inputs.room2_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room2_temp_diff > room2_setpoint_threshold) or force_room2_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room2_climate }}"
                    data:
                      temperature: "{{ room2_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 3 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room3_enabled }}"
        sequence:
          - variables:
              room3_schedule_active: >
                {% if inputs.room3_schedule != "" %}
                  {{ is_state(inputs.room3_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room3_presence: >
                {% if inputs.room3_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room3_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room3_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room3_window_open: >
                {{ (is_state(inputs.room3_window, 'on') if inputs.room3_window != '' else false) or (is_state(inputs.room3_smart_window, 'on') if inputs.room3_smart_window != '' else false) }}
              room3_comfort_temp: >
                {% if inputs.room3_comfort_input != "" %}
                  {{ states(inputs.room3_comfort_input) | float(inputs.room3_comfort_fixed) }}
                {% else %}
                  {{ inputs.room3_comfort_fixed }}
                {% endif %}
              room3_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input %}
                  {{ room3_comfort_temp }}
                {% elif room3_schedule_active or room3_presence %}
                  {{ room3_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room3_final_temp: >
                {% if room3_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room3_schedule_active or room3_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room3_target_temp }}
                {% endif %}
              room3_climate_state: >
                {% if inputs.room3_climate != "" %}
                  {{ states(inputs.room3_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room3_climate_available: >
                {{ inputs.room3_climate != '' and states(inputs.room3_climate) not in ['unknown', 'unavailable'] }}
              room3_current_setpoint: >
                {% if room3_climate_available %}
                  {{ state_attr(inputs.room3_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room3_current_temp: >
                {% if inputs.room3_temp_sensor != "" %}
                  {% if room3_climate_available %}
                    {{ states(inputs.room3_temp_sensor) | float(state_attr(inputs.room3_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room3_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room3_climate_available %}
                  {{ state_attr(inputs.room3_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room3_temp_diff: >
                {{ (room3_final_temp - room3_current_setpoint) | abs }}
              room3_setpoint_threshold: 0.1
              force_room3_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room3_climate != '' and states(inputs.room3_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room3_temp_diff > room3_setpoint_threshold) or force_room3_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room3_climate }}"
                    data:
                      temperature: "{{ room3_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 4 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room4_enabled }}"
        sequence:
          - variables:
              room4_schedule_active: >
                {% if inputs.room4_schedule != "" %}
                  {{ is_state(inputs.room4_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room4_presence: >
                {% if inputs.room4_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room4_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room4_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room4_window_open: >
                {{ (is_state(inputs.room4_window, 'on') if inputs.room4_window != '' else false) or (is_state(inputs.room4_smart_window, 'on') if inputs.room4_smart_window != '' else false) }}
              room4_comfort_temp: >
                {% if inputs.room4_comfort_input != "" %}
                  {{ states(inputs.room4_comfort_input) | float(inputs.room4_comfort_fixed) }}
                {% else %}
                  {{ inputs.room4_comfort_fixed }}
                {% endif %}
              room4_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input %}
                  {{ room4_comfort_temp }}
                {% elif room4_schedule_active or room4_presence %}
                  {{ room4_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room4_final_temp: >
                {% if room4_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room4_schedule_active or room4_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room4_target_temp }}
                {% endif %}
              room4_climate_state: >
                {% if inputs.room4_climate != "" %}
                  {{ states(inputs.room4_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room4_climate_available: >
                {{ inputs.room4_climate != '' and states(inputs.room4_climate) not in ['unknown', 'unavailable'] }}
              room4_current_setpoint: >
                {% if room4_climate_available %}
                  {{ state_attr(inputs.room4_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room4_current_temp: >
                {% if inputs.room4_temp_sensor != "" %}
                  {% if room4_climate_available %}
                    {{ states(inputs.room4_temp_sensor) | float(state_attr(inputs.room4_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room4_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room4_climate_available %}
                  {{ state_attr(inputs.room4_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room4_temp_diff: >
                {{ (room4_final_temp - room4_current_setpoint) | abs }}
              room4_setpoint_threshold: 0.1
              force_room4_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room4_climate != '' and states(inputs.room4_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room4_temp_diff > room4_setpoint_threshold) or force_room4_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room4_climate }}"
                    data:
                      temperature: "{{ room4_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 5 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room5_enabled }}"
        sequence:
          - variables:
              room5_schedule_active: >
                {% if inputs.room5_schedule != "" %}
                  {{ is_state(inputs.room5_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room5_presence: >
                {% if inputs.room5_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room5_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room5_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room5_window_open: >
                {{ (is_state(inputs.room5_window, 'on') if inputs.room5_window != '' else false) or (is_state(inputs.room5_smart_window, 'on') if inputs.room5_smart_window != '' else false) }}
              room5_comfort_temp: >
                {% if inputs.room5_comfort_input != "" %}
                  {{ states(inputs.room5_comfort_input) | float(inputs.room5_comfort_fixed) }}
                {% else %}
                  {{ inputs.room5_comfort_fixed }}
                {% endif %}
              room5_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input %}
                  {{ room5_comfort_temp }}
                {% elif room5_schedule_active or room5_presence %}
                  {{ room5_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room5_final_temp: >
                {% if room5_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room5_schedule_active or room5_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room5_target_temp }}
                {% endif %}
              room5_climate_state: >
                {% if inputs.room5_climate != "" %}
                  {{ states(inputs.room5_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room5_climate_available: >
                {{ inputs.room5_climate != '' and states(inputs.room5_climate) not in ['unknown', 'unavailable'] }}
              room5_current_setpoint: >
                {% if room5_climate_available %}
                  {{ state_attr(inputs.room5_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room5_current_temp: >
                {% if inputs.room5_temp_sensor != "" %}
                  {% if room5_climate_available %}
                    {{ states(inputs.room5_temp_sensor) | float(state_attr(inputs.room5_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room5_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room5_climate_available %}
                  {{ state_attr(inputs.room5_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room5_temp_diff: >
                {{ (room5_final_temp - room5_current_setpoint) | abs }}
              room5_setpoint_threshold: 0.1
              force_room5_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room5_climate != '' and states(inputs.room5_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room5_temp_diff > room5_setpoint_threshold) or force_room5_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room5_climate }}"
                    data:
                      temperature: "{{ room5_final_temp }}"
                    continue_on_error: true

  # ========== FOLLOWER 1 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.follower1_enabled }}"
        sequence:
          - variables:
              follower1_window_open: >
                {{ (is_state(inputs.follower1_window, 'on') if inputs.follower1_window != '' else false) }}
              follower1_target_temp: >
                {% set raw_target = (master_target_final | float(inputs.min_trv_temp)) + (inputs.follower1_offset | float(-2.0)) %}
                {{ [inputs.min_trv_temp | float(12), raw_target] | max }}
              follower1_final_temp: >
                {% if follower1_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (master_schedule_active or master_presence_detected) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ follower1_target_temp }}
                {% endif %}
              follower1_climate_available: >
                {{ inputs.follower1_climate != '' and states(inputs.follower1_climate) not in ['unknown', 'unavailable'] }}
              follower1_current_setpoint: >
                {% if follower1_climate_available %}
                  {{ state_attr(inputs.follower1_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              follower1_current_temp: >
                {% if inputs.follower1_temp_sensor != "" %}
                  {% if follower1_climate_available %}
                    {{ states(inputs.follower1_temp_sensor) | float(state_attr(inputs.follower1_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.follower1_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif follower1_climate_available %}
                  {{ state_attr(inputs.follower1_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              follower1_temp_diff: >
                {{ (follower1_final_temp - follower1_current_setpoint) | abs }}
          - choose:
              - conditions:
                  - "{{ inputs.follower1_climate != '' and states(inputs.follower1_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ follower1_temp_diff > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.follower1_climate }}"
                    data:
                      temperature: "{{ follower1_final_temp }}"
                    continue_on_error: true

  # ========== FOLLOWER 2 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.follower2_enabled }}"
        sequence:
          - variables:
              follower2_window_open: >
                {{ (is_state(inputs.follower2_window, 'on') if inputs.follower2_window != '' else false) }}
              follower2_target_temp: >
                {% set raw_target = (master_target_final | float(inputs.min_trv_temp)) + (inputs.follower2_offset | float(-2.0)) %}
                {{ [inputs.min_trv_temp | float(12), raw_target] | max }}
              follower2_final_temp: >
                {% if follower2_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (master_schedule_active or master_presence_detected) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ follower2_target_temp }}
                {% endif %}
              follower2_climate_available: >
                {{ inputs.follower2_climate != '' and states(inputs.follower2_climate) not in ['unknown', 'unavailable'] }}
              follower2_current_setpoint: >
                {% if follower2_climate_available %}
                  {{ state_attr(inputs.follower2_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              follower2_current_temp: >
                {% if inputs.follower2_temp_sensor != "" %}
                  {% if follower2_climate_available %}
                    {{ states(inputs.follower2_temp_sensor) | float(state_attr(inputs.follower2_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.follower2_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif follower2_climate_available %}
                  {{ state_attr(inputs.follower2_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              follower2_temp_diff: >
                {{ (follower2_final_temp - follower2_current_setpoint) | abs }}
          - choose:
              - conditions:
                  - "{{ inputs.follower2_climate != '' and states(inputs.follower2_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ follower2_temp_diff > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.follower2_climate }}"
                    data:
                      temperature: "{{ follower2_final_temp }}"
                    continue_on_error: true

  # ===== STEP 5.5: MASTER TARGET AGGREGATION & WRITE =====
  - choose:
      - conditions:
          - "{{ master_sensor_available and not safe_mode_blocking }}"
          - "{{ master_climate_available }}"
        sequence:
          - variables:
              # === SCOPE FIX: Ensure room variables exist ===
              room2_final_temp: "{{ room2_final_temp | default(0) }}"
              room2_current_temp: "{{ room2_current_temp | default(0) }}"
              room2_schedule_active: "{{ room2_schedule_active | default(false) }}"
              room2_presence: "{{ room2_presence | default(false) }}"
              room3_final_temp: "{{ room3_final_temp | default(0) }}"
              room3_current_temp: "{{ room3_current_temp | default(0) }}"
              room3_schedule_active: "{{ room3_schedule_active | default(false) }}"
              room3_presence: "{{ room3_presence | default(false) }}"
              room4_final_temp: "{{ room4_final_temp | default(0) }}"
              room4_current_temp: "{{ room4_current_temp | default(0) }}"
              room4_schedule_active: "{{ room4_schedule_active | default(false) }}"
              room4_presence: "{{ room4_presence | default(false) }}"
              room5_final_temp: "{{ room5_final_temp | default(0) }}"
              room5_current_temp: "{{ room5_current_temp | default(0) }}"
              room5_schedule_active: "{{ room5_schedule_active | default(false) }}"
              room5_presence: "{{ room5_presence | default(false) }}"
              # === Continue with existing variables ===
              room_window_trigger_event: >
                {% if trigger is defined and trigger is not none and trigger.id is defined %}
                  {{ trigger.id in ['room2_window_change', 'room3_window_change', 'room4_window_change', 'room5_window_change'] }}
                {% else %}
                  {{ false }}
                {% endif %}
              master_forced_min_active: >
                {{ (master_window_open_too_long | bool(false)) or (window_reheat_blocked | bool(false)) }}
              away_mode_active_effective: >
                {{ (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) }}
              master_safety_floor: >
                {% if away_mode_active_effective | bool(false) %}
                  {{ inputs.min_trv_temp | float(12) }}
                {% else %}
                  {{ eco_temp | float(19) }}
                {% endif %}
              isolated_room_demand_targets: >
                {% set ns = namespace(vals=[]) %}

                {# Room 2 - Isolated only, active heating check #}
                {% if inputs.room2_enabled and inputs.room2_climate != '' and room2_final_temp is defined and room2_current_temp is defined %}
                  {% set room2_effective_target = room2_final_temp | float(0) %}
                  {% set room2_needs_heat = room2_effective_target > ((room2_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room2_active = ((room2_schedule_active | default(false)) | bool(false)) or ((room2_presence | default(false)) | bool(false)) %}
                  {% if room2_needs_heat and room2_active %}
                    {% set ns.vals = ns.vals + [room2_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 3 - Isolated only, active heating check #}
                {% if inputs.room3_enabled and inputs.room3_climate != '' and room3_final_temp is defined and room3_current_temp is defined %}
                  {% set room3_effective_target = room3_final_temp | float(0) %}
                  {% set room3_needs_heat = room3_effective_target > ((room3_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room3_active = ((room3_schedule_active | default(false)) | bool(false)) or ((room3_presence | default(false)) | bool(false)) %}
                  {% if room3_needs_heat and room3_active %}
                    {% set ns.vals = ns.vals + [room3_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 4 - Isolated only, active heating check #}
                {% if inputs.room4_enabled and inputs.room4_climate != '' and room4_final_temp is defined and room4_current_temp is defined %}
                  {% set room4_effective_target = room4_final_temp | float(0) %}
                  {% set room4_needs_heat = room4_effective_target > ((room4_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room4_active = ((room4_schedule_active | default(false)) | bool(false)) or ((room4_presence | default(false)) | bool(false)) %}
                  {% if room4_needs_heat and room4_active %}
                    {% set ns.vals = ns.vals + [room4_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 5 - Isolated only, active heating check #}
                {% if inputs.room5_enabled and inputs.room5_climate != '' and room5_final_temp is defined and room5_current_temp is defined %}
                  {% set room5_effective_target = room5_final_temp | float(0) %}
                  {% set room5_needs_heat = room5_effective_target > ((room5_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room5_active = ((room5_schedule_active | default(false)) | bool(false)) or ((room5_presence | default(false)) | bool(false)) %}
                  {% if room5_needs_heat and room5_active %}
                    {% set ns.vals = ns.vals + [room5_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Follower rooms NEVER included in demand targets #}
                {{ ns.vals }}
              master_presence_priority_active: >
                {% if inputs.master_presence_priority_helper != '' %}
                  {{ is_state(inputs.master_presence_priority_helper, 'on') }}
                {% else %}
                  {{ inputs.enable_master_presence_priority | bool(false) }}
                {% endif %}
              master_base_required_target: >
                {% set demand_targets = isolated_room_demand_targets | default([]) %}
                {% if master_forced_min_active | bool(false) %}
                  {% set target_raw = master_safety_floor | float(12) %}
                {% elif (master_presence_priority_active | bool(false)) and ((master_presence_detected | default(false)) | bool(false)) %}
                  {% set target_raw = master_target_final | float(0) %}
                {% elif demand_targets | length > 0 %}
                  {% set max_room_target = (demand_targets | max | float(0)) %}
                  {% set target_raw = [master_target_final | float(0), max_room_target] | max %}
                {% else %}
                  {% set target_raw = master_target_final | float(0) %}
                {% endif %}
                {{ [target_raw | float(0), master_safety_floor | float(12)] | max }}
              weather_compensation_add: >
                {% if not (inputs.enable_weather_compensation | bool(false)) %}
                  0.0
                {% elif not (outdoor_temp_valid | bool(false)) %}
                  0.0
                {% elif (outdoor_temp | float(0)) <= 0 %}
                  2.0
                {% elif (outdoor_temp | float(0)) >= 10 %}
                  0.0
                {% else %}
                  {% set linear_boost = ((10 - (outdoor_temp | float(0))) / 10) * 2 %}
                  {{ [[linear_boost, 0.0] | max, 2.0] | min }}
                {% endif %}
              master_required_target_raw: >
                {% if master_forced_min_active | bool(false) %}
                  {{ inputs.min_trv_temp | float(12) }}
                {% else %}
                  {{ [((master_base_required_target | float(0)) + (weather_compensation_add | float(0))), (master_safety_floor | float(12))] | max }}
                {% endif %}
              master_min: "{{ state_attr(inputs.master_climate, 'min_temp') | float(inputs.min_trv_temp | float(12)) }}"
              master_max: "{{ state_attr(inputs.master_climate, 'max_temp') | float(30) }}"
              master_required_target: >
                {% set hi = [master_required_target_raw | float(0), master_max | float(30)] | min %}
                {{ [hi, master_min | float(inputs.min_trv_temp | float(12))] | max }}
              master_set_now: "{{ state_attr(inputs.master_climate, 'temperature') | float(0) }}"
              master_target_delta_abs: "{{ ((master_required_target | float(0)) - (master_set_now | float(0))) | abs }}"
              master_needs_global_boost: >
                {{ (not (away_mode_active_effective | bool(false))) and ((master_set_now | float(0)) < ((global_max_demand | float(0)) - 0.1)) }}
              master_needs_global_drop: >
                {{ (not (away_mode_active_effective | bool(false))) and ((master_set_now | float(0)) > ((global_max_demand | float(0)) + 0.1)) }}
              master_significant_drop: >
                {{ ((master_set_now | float(0)) - (master_required_target | float(0))) > 2.0 }}
              effective_max_changes_per_hour: "{{ [inputs.max_changes_per_hour | float(3), 2] | max }}"
              master_change_min_interval_min_step55: "{{ 60 / (effective_max_changes_per_hour | float(3)) }}"
              # API Write Tracking: Letzter erfolgreicher Write an Master-Thermostat
              last_write_timestamp: >
                {% set helper_state = states(inputs.master_last_write_helper) %}
                {% if helper_state in ['unknown', 'unavailable', ''] %}
                  {{ now() - timedelta(hours=24) }}
                {% else %}
                  {% set parsed = helper_state | as_datetime %}
                  {% if parsed is not none %}
                    {{ parsed }}
                  {% else %}
                    {{ now() - timedelta(hours=24) }}
                  {% endif %}
                {% endif %}
              master_last_update_age_step55: >
                {% set helper = inputs.master_last_write_helper %}
                {% if helper != '' and states(helper) not in ['unavailable', 'unknown', ''] %}
                  {% set last_write_str = states(helper) %}
                  {% set last_write_ts = as_timestamp(strptime(last_write_str, '%Y-%m-%d %H:%M:%S')) | float(0) %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {{ now_ts - last_write_ts }}
                {% else %}
                  {{ 999999 }}
                {% endif %}
              master_change_cooldown_ok_step55: >
                {{ (master_last_update_age_step55 | float(999999)) >= (3600 / (effective_max_changes_per_hour | float(3))) }}
              master_needs_raise: >
                {{ (master_required_target | float(0)) > ((master_set_now | float(0)) + (inputs.hysteresis | float(0.6))) }}
              master_excessively_high: >
                {{ master_needs_global_drop | bool(false) }}
              master_stuck_protection_active: >
                {{ (master_needs_raise | bool(false)) and ((master_last_update_age_step55 | float(0)) >= 1800) }}
              master_raise_allowed: >
                {{ (master_needs_raise | bool(false)) and ((master_change_cooldown_ok_step55 | bool(false)) or ((master_target_delta_abs | float(0)) > 3.0) or (master_stuck_protection_active | bool(false))) }}
              master_drop_allowed: >
                {{ (master_excessively_high | bool(false)) and (master_change_cooldown_ok_step55 | bool(false)) }}
              master_write_allowed: >
                {{ (not (room_window_trigger_event | bool(false))) and (not (master_forced_min_active | bool(false))) and ((master_raise_allowed | bool(false)) or (master_drop_allowed | bool(false))) }}
          - choose:
              # PATH A (CRITICAL): forced-min writes bypass cooldown
              - conditions:
                  - "{{ master_forced_min_active | bool(false) }}"
                  - "{{ (master_target_delta_abs | float(0)) > 0.5 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target }}"
                    continue_on_error: true
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
              # PATH B (CRITICAL): highest bidder boost or significant drop bypasses cooldown
              - conditions:
                  - "{{ not (master_forced_min_active | bool(false)) }}"
                  - "{{ (master_needs_global_boost | bool(false)) or (master_significant_drop | bool(false)) }}"
                  - "{{ (master_target_delta_abs | float(0)) > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target }}"
                    continue_on_error: true
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
              # PATH C (COMFORT): regular writes follow cooldown policy
              - conditions:
                  - "{{ master_write_allowed }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target }}"
                    continue_on_error: true
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
