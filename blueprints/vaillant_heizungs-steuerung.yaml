blueprint:
  name: "(Vaillant) Heizungssteuerung"
  description: |
    **Zentrale Heizungslogik fÃ¼r Vaillant-Systeme**

    Dieses Modul bildet das HerzstÃ¼ck der Heizungssteuerung. Es koordiniert den Master-Thermostat und die HeizkÃ¶rperventile (TRVs) basierend auf physikalischem Bedarf, Wetterdaten und Sicherheitslogik.

    **Kern-Funktionen:**
    *   ğŸ›¡ï¸ **Dynamic Safety:** Unterscheidet zwischen KÃ¤lteeinbruch (Not-Aus) und Luftaustausch (Weiterheizen).
    *   ğŸ”— **Smart Follower:** Dynamische Offset-Steuerung fÃ¼r NebenrÃ¤ume (folgen dem Master).
    *   âš¡ **Echtzeit-Reaktion:** Sofortige Anpassung bei StatusÃ¤nderungen ohne Latenz.
    *   ğŸ§  **Fail-Safe:** Mehrstufige Sicherheitslogik (Debounce, Frostschutz, 60min Time-Guard).

    **Das Ã–kosystem:**
    Entwickelt fÃ¼r den Betrieb im Verbund mit:
    *   ğŸ“ `(Vaillant) Geofencing` (Anwesenheit & Eco).
    *   ğŸ’¨ `(Vaillant) LÃ¼ftungs-Steuerung` (Luftaustausch & Feuchtigkeit).
    *   â¤ï¸ `(Vaillant) System-Diagnose` (Wartung & Batterien).

    **Voraussetzungen:**
    Erfordert die **myVaillant** Integration (HACS). Besonderer Dank an die Entwickler dieser Integration fÃ¼r die Bereitstellung der Schnittstelle.

    **Haftungsausschluss:**
    Dies ist ein privates Projekt. Der Autor ist kein zertifizierter Installateur. Die Nutzung erfolgt auf eigene Gefahr. FÃ¼r SchÃ¤den an der Anlage oder durch Fehlkonfiguration wird keine Haftung Ã¼bernommen.

    **Version:** 1.0 (Refactor) | **Autor:** BananaPower

  domain: automation
  source_url: https://raw.githubusercontent.com/howtobanana/vaillant-suite-blueprints/main/blueprints/vaillant_heizungs-steuerung.yaml
  author: "bananapower"

  input:
    section_global:
      name: "ğŸŒ Basisparameter"
      description: |

        Grundlegende Einstellungen fÃ¼r WetterfÃ¼hler, Sommer-Logik, Abwesenheitsstatus und API-Limits.
        Diese Parameter definieren globale Grenzen und Fallback-Werte der Regelung.

      collapsed: false
      input:
        outdoor_temp_sensor:
          name: "ğŸŒ¡ï¸ AuÃŸentemperatur"
          description: |

            Optionaler AuÃŸentemperatursensor fÃ¼r Sommermodus, Frostlogik und Wetterkompensation.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature
        summer_threshold:
          name: "ğŸŒ¡ï¸ Sommer-Grenzwert (Â°C)"
          description: |

            Schwellwert fÃ¼r den Sommer-Modus. Oberhalb dieses Werts wird Heizbetrieb reduziert.

          default: 18
          selector:
            number:
              min: 15
              max: 22
              step: 1
              unit_of_measurement: "Â°C"
        summer_hysteresis:
          name: "â†•ï¸ Sommer-Hysterese (Â°C)"
          description: |

            Verhindert schnelles Takten im Grenzbereich. Hysterese fÃ¼r den Sommer-Modus.

          default: 1.0
          selector:
            number:
              min: 0.5
              max: 3.0
              step: 0.5
              unit_of_measurement: "Â°C"
        panic_mode_enabled:
          name: "ğŸš¨ Panic Mode Helper (opt)"
          description: |

            Globaler Notfall-Schalter. Erzwingt Komfort-Temperatur bei Sensor-Ausfall.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: ""
          selector:
            entity:
              domain: input_boolean
        eco_temp_input:
          name: "ğŸŒ¡ï¸ Eco-Temp Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Eco-Solltemperatur. Ãœberschreibt den Fixwert.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        eco_temp_fixed:
          name: "ğŸŒ¡ï¸ Eco-Temp Fix (Â°C)"
          description: |

            Fallback-Solltemperatur fÃ¼r Eco-Betrieb ohne Helper.

          default: 19
          selector:
            number:
              min: 17
              max: 21
              step: 0.5
              unit_of_measurement: "Â°C"
        away_temp_input:
          name: "ğŸŒ¡ï¸ Away-Temp Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Away-Solltemperatur. Ãœberschreibt den Fixwert.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        away_temp_fixed:
          name: "ğŸŒ¡ï¸ Away-Temp Fix (Â°C)"
          description: |

            Fallback-Solltemperatur fÃ¼r Abwesenheitsbetrieb ohne Helper.

          default: 16
          selector:
            number:
              min: 14
              max: 18
              step: 0.5
              unit_of_measurement: "Â°C"

        away_mode_boolean:
          name: "Away-Mode Helper (input_boolean)"
          description: |

            Globaler Abwesenheits-Schalter. Aktiviert sofort den Away-Sollwert. Mehrere Entitys werden als ODER ausgewertet.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: []
          selector:
            entity:
              domain: input_boolean
              multiple: true
        max_changes_per_hour:
          name: "ğŸ”§ Max Ã„nderungen/h"
          description: |

            Maximale Anzahl Master-SchreibvorgÃ¤nge pro Stunde.
            Hohe Werte erlauben bei netzbetriebenen GerÃ¤ten nahezu sofortige Aktualisierungen.

          default: 10
          selector:
            number:
              min: 2
              max: 20
              step: 1

    section_master:
      name: "ğŸ  Master-Raum"
      description: |

        Parameter fÃ¼r den fÃ¼hrenden Master-Raum und die zentrale Sollwertstrategie.
        Der Master-Thermostat ist die primÃ¤re Schnittstelle zur Heizungsanlage.

      collapsed: false
      input:
        master_climate:
          name: "â™¨ï¸ Master Thermostat (Pflicht)"
          description: |

            Erforderlicher Master-Thermostat. PrimÃ¤res Zielsystem fÃ¼r Sollwertvorgaben.

          default: ""
          selector:
            entity:
              domain: climate
        master_last_write_helper:
          name: "ğŸ“ Master Last Write Tracker"
          description: |
            **Pflicht-Helper fÃ¼r API-Cooldown-Tracking.**

            **Typ:** `input_datetime` (mit Datum + Uhrzeit).

            Dieser Helper speichert den Zeitstempel des letzten erfolgreichen API-Writes an den Master-Thermostat.

            âš ï¸ **NICHT manuell Ã¤ndern!** Wird automatisch vom Blueprint verwaltet.

            **Erstellen in Home Assistant:**
            Einstellungen â†’ GerÃ¤te & Dienste â†’ Helfer â†’ Helfer erstellen â†’ Datum und/oder Uhrzeit â†’ Name: "Vaillant Master Last Write" â†’ Datum UND Uhrzeit aktivieren.
          selector:
            entity:
              domain: input_datetime
        master_comfort_input:
          name: "ğŸŒ¡ï¸ Master Komfort Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Komfort-Solltemperatur des Master-Raums.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        master_comfort_fixed:
          name: "ğŸŒ¡ï¸ Master Komfort Fix (Â°C)"
          description: |

            Fallback-Komforttemperatur des Master-Raums ohne Helper.

          default: 20.5
          selector:
            number:
              min: 19
              max: 24
              step: 0.5
              unit_of_measurement: "Â°C"
        master_schedule:
          name: "ğŸ—“ï¸ Master Zeitplan"
          description: |

            Optionaler Zeitplan fÃ¼r den Komfortbetrieb im Master-Raum.

          default: ""
          selector:
            entity:
              domain: schedule
        master_presence_sensors:
          name: "ğŸ‘€ Master PrÃ¤senz"
          description: |

            Optionale PrÃ¤senzsensoren fÃ¼r bedarfsgefÃ¼hrten Komfortbetrieb im Master-Raum.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        presence_activation_delay:
          name: "â±ï¸ PrÃ¤senz Aktivierung (min)"
          description: |

            VerzÃ¶gerung bis PrÃ¤senz als aktiv bewertet wird.

          default: 2
          selector:
            number:
              min: 0
              max: 10
              step: 1
              unit_of_measurement: "min"
        presence_deactivation_delay:
          name: "â±ï¸ PrÃ¤senz Nachlauf (min)"
          description: |

            Nachlaufzeit bis RÃ¼ckfall auf Eco nach letzter PrÃ¤senz.

          default: 30
          selector:
            number:
              min: 30
              max: 120
              step: 5
              unit_of_measurement: "min"
        master_presence_helper:
          name: "Master Presence Helper Entity"
          description: |

            Input boolean to store master presence state. Create manually: Settings -> Helpers -> Toggle -> Name: 'Heating: Master Presence Active'

          selector:
            entity:
              domain: input_boolean
        enable_master_presence_priority:
          name: "ğŸ‘‘ Master gewinnt bei PrÃ¤senz"
          description: |

            Aktiviert Vorrang des Master-Raums gegenÃ¼ber isolierten RÃ¤umen bei PrÃ¤senz.

          default: false
          selector:
            boolean:
        master_presence_priority_helper:
          name: "ğŸ§© Master-PrioritÃ¤t Helper (opt)"
          description: |

            Optionaler Laufzeit-Override fÃ¼r Master-PrioritÃ¤t. ON = Vorrang aktiv.
            Erforderlicher Helfer-Typ: **Umschalter** (input_boolean).

          default: ""
          selector:
            entity:
              domain: input_boolean
        enable_room_boost:
          name: "ğŸš€ Room-Boost aktivieren"
          description: |

            Hebt den Master-Sollwert an, wenn ein Raum deutlich unter seinem Ziel liegt.
            Boost endet automatisch bei <= 0.5 Â°C Restabweichung (Anti-Overshoot).

          default: true
          selector:
            boolean:
        room_boost_threshold:
          name: "ğŸŒ¡ï¸ Room-Boost Schwellwert (Â°C)"
          description: |

            Mindestabweichung eines Raums unter Soll, ab der Boost aktiviert wird.
            Sobald ein Raum <= 0.5 Â°C unter Soll liegt, wird Boost wieder deaktiviert.

          default: 0.5
          selector:
            number:
              min: 0.2
              max: 2.0
              step: 0.1
              unit_of_measurement: "Â°C"
        room_boost_amount:
          name: "âš¡ Room-Boost HÃ¶he (Â°C)"
          description: |

            ZusÃ¤tzliche ErhÃ¶hung des Master-Sollwerts bei aktivem Boost.
            0 = aus, 1 = konservativ, 2 = empfohlen, 3 = aggressiv.

          default: 2.0
          selector:
            number:
              min: 0
              max: 3.0
              step: 0.5
              unit_of_measurement: "Â°C"
        master_smart_window:
          name: "ğŸ§  Master Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor. Wird logisch ODER mit dem Hardwarekontakt verknÃ¼pft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        master_temp_sensor:
          name: "ğŸŒ¡ï¸ Master Temperatursensor"
          description: |

            Optionaler externer Temperatursensor des Master-Raums.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature
        master_humidity_sensor:
          name: "ğŸ’§ Master Feuchte"
          description: |

            Optionaler Luftfeuchtesensor fÃ¼r Feuchtekompensation im Master-Raum.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: humidity

    section_follower_1:
      name: "ğŸ”— Verbundener Raum 1 (z.B. Flur)"
      description: |

        Verbundener Raum folgt dem Master-Sollwert mit Offset.
        Der Raum erhÃ¶ht den Master-Sollwert nicht.

      collapsed: true
      input:
        follower1_enabled:
          name: "ğŸ”˜ Follower 1 Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Follower-Raum 1.

          default: false
          selector:
            boolean:
        follower1_name:
          name: "ğŸ“ Follower 1 Name (opt)"
          description: |

            Optionaler Anzeigename fÃ¼r UI und Protokollierung von Follower-Raum 1.

          default: ""
          selector:
            text:
        follower1_climate:
          name: "â™¨ï¸ Follower 1 TRV"
          description: |

            TRV/Thermostat fÃ¼r Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: climate
        follower1_offset:
          name: "â†˜ï¸ Follower 1 Offset (Â°C)"
          description: |

            Temperatur-Offset relativ zum Master-Sollwert fÃ¼r Follower-Raum 1. Negative Werte senken den Sollwert.

          default: -2.0
          selector:
            number:
              min: -3.0
              max: -0.5
              step: 0.5
              unit_of_measurement: "Â°C"
        follower1_window:
          name: "ğŸªŸ Follower 1 Fenster (opt)"
          description: |

            Optionaler Fensterkontakt fÃ¼r Sicherheitsabsenkung in Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        follower1_temp_sensor:
          name: "ğŸŒ¡ï¸ Follower 1 Temperatursensor (opt)"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Follower-Raum 1.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_follower_2:
      name: "ğŸ”— Verbundener Raum 2 (z.B. Durchgangszimmer)"
      description: |

        Verbundener Raum folgt dem Master-Sollwert mit Offset.
        Der Raum erhÃ¶ht den Master-Sollwert nicht.

      collapsed: true
      input:
        follower2_enabled:
          name: "ğŸ”˜ Follower 2 Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Follower-Raum 2.

          default: false
          selector:
            boolean:
        follower2_name:
          name: "ğŸ“ Follower 2 Name (opt)"
          description: |

            Optionaler Anzeigename fÃ¼r UI und Protokollierung von Follower-Raum 2.

          default: ""
          selector:
            text:
        follower2_climate:
          name: "â™¨ï¸ Follower 2 TRV"
          description: |

            TRV/Thermostat fÃ¼r Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: climate
        follower2_offset:
          name: "â†˜ï¸ Follower 2 Offset (Â°C)"
          description: |

            Temperatur-Offset relativ zum Master-Sollwert fÃ¼r Follower-Raum 2. Negative Werte senken den Sollwert.

          default: -2.0
          selector:
            number:
              min: -3.0
              max: -0.5
              step: 0.5
              unit_of_measurement: "Â°C"
        follower2_window:
          name: "ğŸªŸ Follower 2 Fenster (opt)"
          description: |

            Optionaler Fensterkontakt fÃ¼r Sicherheitsabsenkung in Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        follower2_temp_sensor:
          name: "ğŸŒ¡ï¸ Follower 2 Temperatursensor (opt)"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Follower-Raum 2.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_room2:
      name: "ğŸ›ï¸ Raum 2"
      description: |

        Isolierter Raum mit eigener Komfortlogik Ã¼ber Zeitplan und PrÃ¤senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room2_enabled:
          name: "ğŸ”˜ Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Raum 2.

          default: false
          selector:
            boolean:
        room2_climate:
          name: "â™¨ï¸ TRV"
          description: |

            TRV/Thermostat fÃ¼r Raum 2.

          default: ""
          selector:
            entity:
              domain: climate
        room2_comfort_input:
          name: "ğŸŒ¡ï¸ Komfort Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Komfort-Solltemperatur in Raum 2.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room2_comfort_fixed:
          name: "ğŸŒ¡ï¸ Komfort Fix (Â°C)"
          description: |

            Fallback-Komforttemperatur in Raum 2 ohne Helper.

          default: 21.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "Â°C"
        room2_schedule:
          name: "ğŸ—“ï¸ Zeitplan"
          description: |

            Optionaler Zeitplan fÃ¼r Komfortbetrieb in Raum 2.

          default: ""
          selector:
            entity:
              domain: schedule
        room2_presence_sensors:
          name: "ğŸ‘€ PrÃ¤senz"
          description: |

            Optionale PrÃ¤senzsensoren fÃ¼r Komfortfreigabe in Raum 2.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room2_presence_delay:
          name: "â±ï¸ Nachlauf (min)"
          description: |

            Nachlaufzeit bis RÃ¼ckfall auf Eco in Raum 2.

          default: 30
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room2_presence_helper:
          name: "Room2 Presence Helper Entity"
          description: |

            Input boolean for room2 presence state. Create manually: Settings -> Helpers -> Toggle -> Name: 'Heating: Room2 Presence Active'

          default: ""
          selector:
            entity:
              domain: input_boolean
        room2_window:
          name: "ğŸªŸ Fenster"
          description: |

            Fensterkontakt in Raum 2 fÃ¼r Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room2_smart_window:
          name: "ğŸ§  Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 2. Wird mit Hardwarekontakt logisch ODER verknÃ¼pft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room2_temp_sensor:
          name: "ğŸŒ¡ï¸ Temperatursensor"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Raum 2.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room3:
      name: "ğŸ’» Raum 3"
      description: |

        Isolierter Raum mit eigener Komfortlogik Ã¼ber Zeitplan und PrÃ¤senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room3_enabled:
          name: "ğŸ”˜ Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Raum 3.

          default: false
          selector:
            boolean:
        room3_climate:
          name: "â™¨ï¸ TRV"
          description: |

            TRV/Thermostat fÃ¼r Raum 3.

          default: ""
          selector:
            entity:
              domain: climate
        room3_comfort_input:
          name: "ğŸŒ¡ï¸ Komfort Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Komfort-Solltemperatur in Raum 3.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room3_comfort_fixed:
          name: "ğŸŒ¡ï¸ Komfort Fix (Â°C)"
          description: |

            Fallback-Komforttemperatur in Raum 3 ohne Helper.

          default: 20.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "Â°C"
        room3_schedule:
          name: "ğŸ—“ï¸ Zeitplan"
          description: |

            Optionaler Zeitplan fÃ¼r Komfortbetrieb in Raum 3.

          default: ""
          selector:
            entity:
              domain: schedule
        room3_presence_sensors:
          name: "ğŸ‘€ PrÃ¤senz"
          description: |

            Optionale PrÃ¤senzsensoren fÃ¼r Komfortfreigabe in Raum 3.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room3_presence_delay:
          name: "â±ï¸ Nachlauf (min)"
          description: |

            Nachlaufzeit bis RÃ¼ckfall auf Eco in Raum 3.

          default: 30
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room3_presence_helper:
          name: "Room3 Presence Helper Entity"
          description: |

            Input boolean for room3 presence state. Create manually: Settings -> Helpers -> Toggle -> Name: 'Heating: Room3 Presence Active'

          default: ""
          selector:
            entity:
              domain: input_boolean
        room3_window:
          name: "ğŸªŸ Fenster"
          description: |

            Fensterkontakt in Raum 3 fÃ¼r Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room3_smart_window:
          name: "ğŸ§  Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 3. Wird mit Hardwarekontakt logisch ODER verknÃ¼pft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room3_temp_sensor:
          name: "ğŸŒ¡ï¸ Temperatursensor"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Raum 3.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room4:
      name: "ğŸ› Raum 4"
      description: |

        Isolierter Raum mit eigener Komfortlogik Ã¼ber Zeitplan und PrÃ¤senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room4_enabled:
          name: "ğŸ”˜ Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Raum 4.

          default: false
          selector:
            boolean:
        room4_climate:
          name: "â™¨ï¸ TRV"
          description: |

            TRV/Thermostat fÃ¼r Raum 4.

          default: ""
          selector:
            entity:
              domain: climate
        room4_comfort_input:
          name: "ğŸŒ¡ï¸ Komfort Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Komfort-Solltemperatur in Raum 4.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room4_comfort_fixed:
          name: "ğŸŒ¡ï¸ Komfort Fix (Â°C)"
          description: |

            Fallback-Komforttemperatur in Raum 4 ohne Helper.

          default: 22.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "Â°C"
        room4_schedule:
          name: "ğŸ—“ï¸ Zeitplan"
          description: |

            Optionaler Zeitplan fÃ¼r Komfortbetrieb in Raum 4.

          default: ""
          selector:
            entity:
              domain: schedule
        room4_presence_sensors:
          name: "ğŸ‘€ PrÃ¤senz"
          description: |

            Optionale PrÃ¤senzsensoren fÃ¼r Komfortfreigabe in Raum 4.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room4_presence_delay:
          name: "â±ï¸ Nachlauf (min)"
          description: |

            Nachlaufzeit bis RÃ¼ckfall auf Eco in Raum 4.

          default: 20
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room4_presence_helper:
          name: "Room4 Presence Helper Entity"
          description: |

            Input boolean for room4 presence state. Create manually: Settings -> Helpers -> Toggle -> Name: 'Heating: Room4 Presence Active'

          default: ""
          selector:
            entity:
              domain: input_boolean
        room4_window:
          name: "ğŸªŸ Fenster"
          description: |

            Fensterkontakt in Raum 4 fÃ¼r Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room4_smart_window:
          name: "ğŸ§  Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 4. Wird mit Hardwarekontakt logisch ODER verknÃ¼pft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room4_temp_sensor:
          name: "ğŸŒ¡ï¸ Temperatursensor"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Raum 4.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature

    section_room5:
      name: "ğŸ³ Raum 5"
      description: |

        Isolierter Raum mit eigener Komfortlogik Ã¼ber Zeitplan und PrÃ¤senz.
        Aktive Raumanforderung kann den Master-Sollwert anheben.

      collapsed: true
      input:
        room5_enabled:
          name: "ğŸ”˜ Aktiv"
          description: |

            Aktiviert die Regelung fÃ¼r Raum 5.

          default: false
          selector:
            boolean:
        room5_climate:
          name: "â™¨ï¸ TRV"
          description: |

            TRV/Thermostat fÃ¼r Raum 5.

          default: ""
          selector:
            entity:
              domain: climate
        room5_comfort_input:
          name: "ğŸŒ¡ï¸ Komfort Helper (opt)"
          description: |

            Optionaler Helper fÃ¼r die Komfort-Solltemperatur in Raum 5.
            Erforderlicher Helfer-Typ: **Schieberegler** (input_number).

          default: ""
          selector:
            entity:
              domain: input_number
        room5_comfort_fixed:
          name: "ğŸŒ¡ï¸ Komfort Fix (Â°C)"
          description: |

            Fallback-Komforttemperatur in Raum 5 ohne Helper.

          default: 21.0
          selector:
            number:
              min: 18
              max: 24
              step: 0.5
              unit_of_measurement: "Â°C"
        room5_schedule:
          name: "ğŸ—“ï¸ Zeitplan"
          description: |

            Optionaler Zeitplan fÃ¼r Komfortbetrieb in Raum 5.

          default: ""
          selector:
            entity:
              domain: schedule
        room5_presence_sensors:
          name: "ğŸ‘€ PrÃ¤senz"
          description: |

            Optionale PrÃ¤senzsensoren fÃ¼r Komfortfreigabe in Raum 5.

          default: []
          selector:
            entity:
              domain: binary_sensor
              device_class: occupancy
              multiple: true
        room5_presence_delay:
          name: "â±ï¸ Nachlauf (min)"
          description: |

            Nachlaufzeit bis RÃ¼ckfall auf Eco in Raum 5.

          default: 45
          selector:
            number:
              min: 15
              max: 120
              step: 5
              unit_of_measurement: "min"
        room5_presence_helper:
          name: "Room5 Presence Helper Entity"
          description: |

            Input boolean for room5 presence state. Create manually: Settings -> Helpers -> Toggle -> Name: 'Heating: Room5 Presence Active'

          default: ""
          selector:
            entity:
              domain: input_boolean
        room5_window:
          name: "ğŸªŸ Fenster"
          description: |

            Fensterkontakt in Raum 5 fÃ¼r Sicherheitsabsenkung.

          default: ""
          selector:
            entity:
              domain: binary_sensor
              device_class: window
        room5_smart_window:
          name: "ğŸ§  Smart-Fenster (opt)"
          description: |

            Optionaler virtueller Fenstersensor in Raum 5. Wird mit Hardwarekontakt logisch ODER verknÃ¼pft.

          default: ""
          selector:
            entity:
              domain: binary_sensor
        room5_temp_sensor:
          name: "ğŸŒ¡ï¸ Temperatursensor"
          description: |

            Optionaler externer Temperatursensor fÃ¼r Raum 5.

          default: ""
          selector:
            entity:
              domain: sensor
              device_class: temperature


    section_smart_functions:
      name: "ğŸ§  Regelungsparameter & Smarte Funktionen"
      description: |

        Feinparameter fÃ¼r Sicherheitsabsenkung, Hysterese und adaptive Sollwertlogik.
        Diese Einstellungen steuern Reaktionsgeschwindigkeit und StabilitÃ¤t der Regelung.

      collapsed: true
      input:
        min_trv_temp:
          name: "â™¨ï¸ TRV Minimum (Â°C)"
          description: |

            Mindest-Solltemperatur fÃ¼r Frostschutz und Sicherheitsabsenkung.

          default: 12
          selector:
            number:
              min: 5
              max: 15
              step: 0.5
              unit_of_measurement: "Â°C"
        window_heat_delay:
          name: "â±ï¸ Fenster-Delay (min)"
          description: |

            Fallback-Zeitlimit bei offenem Fenster bis zur Sicherheitsabsenkung.

          default: 15
          selector:
            number:
              min: 5
              max: 30
              step: 5
              unit_of_measurement: "min"
        smart_drop_threshold:
          name: "ğŸ“‰ Smart-Drop Schwelle (Â°C)"
          description: |

            Temperatursturz-Erkennung. Schaltet Heizung ab, wenn Ist-Wert um X Â°C unter Soll-Wert fÃ¤llt.

          default: 2.0
          selector:
            number:
              min: 0.0
              max: 5.0
              step: 0.5
              unit_of_measurement: "Â°C"
        hysteresis:
          name: "âš™ï¸ Hysterese (Â°C)"
          description: |

            Mindestabweichung zwischen aktuellem und neuem Sollwert vor Schreibvorgang.

          default: 0.6
          selector:
            number:
              min: 0.1
              max: 1.0
              step: 0.1
              unit_of_measurement: "Â°C"
        enable_weather_compensation:
          name: "ğŸŒ¦ï¸ Wetter-Kompensation aktiv"
          description: |

            Aktiviert lineare Sollwertanhebung bei niedriger AuÃŸentemperatur.

          default: false
          selector:
            boolean:
        enable_humidity_compensation:
          name: "ğŸ”˜ Feuchte-Kompensation"
          description: |

            Aktiviert Sollwertabsenkung bei hoher Luftfeuchte im Master-Raum.

          default: false
          selector:
            boolean:


mode: restart

trigger:
  # ============================================
  # PRESENCE TRIGGERS
  # ============================================
  - platform: state
    entity_id: !input master_presence_sensors
    to: "on"
    for:
      minutes: !input presence_activation_delay
    id: master_presence_on
  - platform: state
    entity_id: !input master_presence_sensors
    to: "off"
    for:
      minutes: !input presence_deactivation_delay
    id: master_presence_off
  - platform: state
    entity_id: !input room2_presence_sensors
    to: "on"
    for:
      minutes: !input room2_presence_delay
    id: room2_presence_on
  - platform: state
    entity_id: !input room2_presence_sensors
    to: "off"
    for:
      minutes: !input room2_presence_delay
    id: room2_presence_off
  - platform: state
    entity_id: !input room3_presence_sensors
    to: "on"
    for:
      minutes: !input room3_presence_delay
    id: room3_presence_on
  - platform: state
    entity_id: !input room3_presence_sensors
    to: "off"
    for:
      minutes: !input room3_presence_delay
    id: room3_presence_off
  - platform: state
    entity_id: !input room4_presence_sensors
    to: "on"
    for:
      minutes: !input room4_presence_delay
    id: room4_presence_on
  - platform: state
    entity_id: !input room4_presence_sensors
    to: "off"
    for:
      minutes: !input room4_presence_delay
    id: room4_presence_off
  - platform: state
    entity_id: !input room5_presence_sensors
    to: "on"
    for:
      minutes: !input room5_presence_delay
    id: room5_presence_on
  - platform: state
    entity_id: !input room5_presence_sensors
    to: "off"
    for:
      minutes: !input room5_presence_delay
    id: room5_presence_off

  # ============================================
  # SCHEDULED TRIGGER (for temp logic)
  # ============================================
  - platform: time_pattern
    minutes: "/1"
    id: scheduled

condition: []

action:
  # ============================================
  # PRESENCE STATE MANAGEMENT
  # ============================================
  - variables:
      master_presence_helper: !input master_presence_helper
      room2_presence_helper: !input room2_presence_helper
      room3_presence_helper: !input room3_presence_helper
      room4_presence_helper: !input room4_presence_helper
      room5_presence_helper: !input room5_presence_helper
      presence_activation_delay: !input presence_activation_delay
      presence_deactivation_delay: !input presence_deactivation_delay
  - choose:
      - conditions:
          - condition: trigger
            id: master_presence_on
        sequence:
          - condition: template
            value_template: "{{ master_presence_helper != '' }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ master_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Master Presence ACTIVATED (sensor ON >{{ presence_activation_delay }}min)"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: master_presence_off
        sequence:
          - condition: template
            value_template: "{{ master_presence_helper != '' }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ master_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Master Presence DEACTIVATED (sensor OFF >{{ presence_deactivation_delay }}min)"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room2_presence_on
        sequence:
          - condition: template
            value_template: "{{ room2_presence_helper != '' }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ room2_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room2 Presence ACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room2_presence_off
        sequence:
          - condition: template
            value_template: "{{ room2_presence_helper != '' }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ room2_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room2 Presence DEACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room3_presence_on
        sequence:
          - condition: template
            value_template: "{{ room3_presence_helper != '' }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ room3_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room3 Presence ACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room3_presence_off
        sequence:
          - condition: template
            value_template: "{{ room3_presence_helper != '' }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ room3_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room3 Presence DEACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room4_presence_on
        sequence:
          - condition: template
            value_template: "{{ room4_presence_helper != '' }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ room4_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room4 Presence ACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room4_presence_off
        sequence:
          - condition: template
            value_template: "{{ room4_presence_helper != '' }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ room4_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room4 Presence DEACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room5_presence_on
        sequence:
          - condition: template
            value_template: "{{ room5_presence_helper != '' }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ room5_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room5 Presence ACTIVATED"
              level: info
          - stop: ""
      - conditions:
          - condition: trigger
            id: room5_presence_off
        sequence:
          - condition: template
            value_template: "{{ room5_presence_helper != '' }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ room5_presence_helper }}"
          - service: system_log.write
            data:
              message: "Vaillant Blueprint: Room5 Presence DEACTIVATED"
              level: info
          - stop: ""

  # Continue to scheduled logic if no presence trigger matched
  - variables:
      # ===== GROUP 1: INPUTS & HELPERS =====
      inputs:
        outdoor_temp_sensor: !input outdoor_temp_sensor
        summer_threshold: !input summer_threshold
        summer_hysteresis: !input summer_hysteresis
        panic_mode_enabled: !input panic_mode_enabled
        eco_temp_input: !input eco_temp_input
        eco_temp_fixed: !input eco_temp_fixed
        away_temp_input: !input away_temp_input
        away_temp_fixed: !input away_temp_fixed
        away_mode_boolean: !input away_mode_boolean
        min_trv_temp: !input min_trv_temp
        window_heat_delay: !input window_heat_delay
        smart_drop_threshold: !input smart_drop_threshold
        hysteresis: !input hysteresis
        max_changes_per_hour: !input max_changes_per_hour
        enable_weather_compensation: !input enable_weather_compensation
        enable_humidity_compensation: !input enable_humidity_compensation
        master_climate: !input master_climate
        master_last_write_helper: !input master_last_write_helper
        master_comfort_input: !input master_comfort_input
        master_comfort_fixed: !input master_comfort_fixed
        master_schedule: !input master_schedule
        master_presence_sensors: !input master_presence_sensors
        master_presence_helper: !input master_presence_helper
        presence_activation_delay: !input presence_activation_delay
        presence_deactivation_delay: !input presence_deactivation_delay
        enable_master_presence_priority: !input enable_master_presence_priority
        master_presence_priority_helper: !input master_presence_priority_helper
        enable_room_boost: !input enable_room_boost
        room_boost_threshold: !input room_boost_threshold
        room_boost_amount: !input room_boost_amount
        master_smart_window: !input master_smart_window
        master_temp_sensor: !input master_temp_sensor
        master_humidity_sensor: !input master_humidity_sensor
        room2_enabled: !input room2_enabled
        room2_climate: !input room2_climate
        room2_comfort_input: !input room2_comfort_input
        room2_comfort_fixed: !input room2_comfort_fixed
        room2_schedule: !input room2_schedule
        room2_presence_sensors: !input room2_presence_sensors
        room2_presence_helper: !input room2_presence_helper
        room2_presence_delay: !input room2_presence_delay
        room2_window: !input room2_window
        room2_smart_window: !input room2_smart_window
        room2_temp_sensor: !input room2_temp_sensor
        room3_enabled: !input room3_enabled
        room3_climate: !input room3_climate
        room3_comfort_input: !input room3_comfort_input
        room3_comfort_fixed: !input room3_comfort_fixed
        room3_schedule: !input room3_schedule
        room3_presence_sensors: !input room3_presence_sensors
        room3_presence_helper: !input room3_presence_helper
        room3_presence_delay: !input room3_presence_delay
        room3_window: !input room3_window
        room3_smart_window: !input room3_smart_window
        room3_temp_sensor: !input room3_temp_sensor
        room4_enabled: !input room4_enabled
        room4_climate: !input room4_climate
        room4_comfort_input: !input room4_comfort_input
        room4_comfort_fixed: !input room4_comfort_fixed
        room4_schedule: !input room4_schedule
        room4_presence_sensors: !input room4_presence_sensors
        room4_presence_helper: !input room4_presence_helper
        room4_presence_delay: !input room4_presence_delay
        room4_window: !input room4_window
        room4_smart_window: !input room4_smart_window
        room4_temp_sensor: !input room4_temp_sensor
        room5_enabled: !input room5_enabled
        room5_climate: !input room5_climate
        room5_comfort_input: !input room5_comfort_input
        room5_comfort_fixed: !input room5_comfort_fixed
        room5_schedule: !input room5_schedule
        room5_presence_sensors: !input room5_presence_sensors
        room5_presence_helper: !input room5_presence_helper
        room5_presence_delay: !input room5_presence_delay
        room5_window: !input room5_window
        room5_smart_window: !input room5_smart_window
        room5_temp_sensor: !input room5_temp_sensor
        follower1_enabled: !input follower1_enabled
        follower1_name: !input follower1_name
        follower1_climate: !input follower1_climate
        follower1_offset: !input follower1_offset
        follower1_window: !input follower1_window
        follower1_temp_sensor: !input follower1_temp_sensor
        follower2_enabled: !input follower2_enabled
        follower2_name: !input follower2_name
        follower2_climate: !input follower2_climate
        follower2_offset: !input follower2_offset
        follower2_window: !input follower2_window
        follower2_temp_sensor: !input follower2_temp_sensor
      helper_input_settle_seconds: 30
      trigger_id_safe: >
        {% if trigger is defined and trigger is not none and trigger.id is defined %}
          {{ trigger.id }}
        {% else %}

        {% endif %}
      helper_input_trigger: >
        {{ trigger_id_safe in [
          'eco_temp_input_change',
          'away_temp_input_change',
          'master_comfort_input_change',
          'room2_comfort_input_change',
          'room3_comfort_input_change',
          'room4_comfort_input_change',
          'room5_comfort_input_change',
          'awaymodechange'
        ] }}
      helper_input_trigger_entity: >
        {% if not helper_input_trigger %}

        {% elif trigger is defined and trigger is not none and trigger.event is defined and trigger.event.data is defined and trigger.event.data.entity_id is defined %}
          {{ trigger.event.data.entity_id }}
        {% elif trigger is defined and trigger is not none and trigger.entity_id is defined and trigger.entity_id is not none %}
          {{ trigger.entity_id }}
        {% else %}

        {% endif %}
      helper_input_trigger_ts: >
        {% if not helper_input_trigger %}
          {{ as_timestamp(now()) }}
        {% elif trigger is defined and trigger is not none and trigger.event is defined and trigger.event.time_fired is defined %}
          {{ as_timestamp(trigger.event.time_fired, as_timestamp(now())) }}
        {% elif trigger is defined and trigger is not none and trigger.to_state is defined and trigger.to_state is not none and trigger.to_state.last_changed is defined %}
          {{ as_timestamp(trigger.to_state.last_changed, as_timestamp(now())) }}
        {% else %}
          {{ as_timestamp(now()) }}
        {% endif %}

      # ===== GROUP 2: ROOM STATES =====
      master_schedule_active: >
        {% if inputs.master_schedule != "" %}
          {{ is_state(inputs.master_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      master_presence_detected: >
        {{ is_state(inputs.master_presence_helper, 'on') if inputs.master_presence_helper != '' else false }}
      room2_schedule_active_for_demand: >
        {% if inputs.room2_enabled and inputs.room2_schedule != "" %}
          {{ is_state(inputs.room2_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room2_presence_for_demand: >
        {{ is_state(inputs.room2_presence_helper, 'on') if inputs.room2_presence_helper != '' else false }}
      room3_schedule_active_for_demand: >
        {% if inputs.room3_enabled and inputs.room3_schedule != "" %}
          {{ is_state(inputs.room3_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room3_presence_for_demand: >
        {{ is_state(inputs.room3_presence_helper, 'on') if inputs.room3_presence_helper != '' else false }}
      room4_schedule_active_for_demand: >
        {% if inputs.room4_enabled and inputs.room4_schedule != "" %}
          {{ is_state(inputs.room4_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room4_presence_for_demand: >
        {{ is_state(inputs.room4_presence_helper, 'on') if inputs.room4_presence_helper != '' else false }}
      room5_schedule_active_for_demand: >
        {% if inputs.room5_enabled and inputs.room5_schedule != "" %}
          {{ is_state(inputs.room5_schedule, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      room5_presence_for_demand: >
        {{ is_state(inputs.room5_presence_helper, 'on') if inputs.room5_presence_helper != '' else false }}
      master_window_sensor_configured: >
        {{ inputs.master_smart_window != '' }}
      master_window_open: >
        {{ is_state(inputs.master_smart_window, 'on') if inputs.master_smart_window != '' else false }}
      master_window_open_too_long: >
        {% if master_window_sensor_configured and (master_window_open | bool(false)) %}
          {% if inputs.master_smart_window != '' and is_state(inputs.master_smart_window, 'on') %}
            {% set win_state = expand([inputs.master_smart_window]) | first %}
          {% else %}
            {% set win_state = none %}
          {% endif %}
          {% set now_ts = as_timestamp(now()) %}
          {% if win_state is not none and win_state.last_changed is defined and win_state.last_changed is not none %}
            {% set opened_ts = as_timestamp(win_state.last_changed, now_ts) %}
            {% set timer_expired = (now_ts - opened_ts) >= ((inputs.window_heat_delay | float(0)) * 60) %}
          {% else %}
            {% set timer_expired = false %}
          {% endif %}
          {% if inputs.master_temp_sensor != '' %}
            {% if inputs.master_climate != '' %}
              {% set current_temp = states(inputs.master_temp_sensor) | float(state_attr(inputs.master_climate, 'current_temperature') | float(21)) %}
            {% else %}
              {% set current_temp = states(inputs.master_temp_sensor) | float(21) %}
            {% endif %}
          {% elif inputs.master_climate != '' %}
            {% set current_temp = state_attr(inputs.master_climate, 'current_temperature') | float(21) %}
          {% else %}
            {% set current_temp = 21 %}
          {% endif %}
          {% if inputs.master_climate != '' %}
            {% set target_temp = state_attr(inputs.master_climate, 'temperature') | float(21) %}
          {% else %}
            {% set target_temp = master_target_temp | float(21) %}
          {% endif %}
          {% set drop_threshold = inputs.smart_drop_threshold | float(2.0) %}
          {% set temp_dropped = (drop_threshold <= 0) or (current_temp < (target_temp - drop_threshold)) %}
          {{ temp_dropped or timer_expired }}
        {% else %}
          {{ false }}
        {% endif %}
      master_window_recently_closed: >
        {% if not (master_window_sensor_configured | bool(false)) %}
          {{ false }}
        {% elif trigger is defined and trigger is not none and trigger.id is defined and trigger.id == 'master_smart_window_change' %}
          {% if trigger.to_state is defined and trigger.to_state is not none and trigger.from_state is defined and trigger.from_state is not none %}
            {{ (trigger.from_state.state == 'on') and (trigger.to_state.state == 'off') }}
          {% else %}
            {% set now_ts = as_timestamp(now(), 0) %}
            {% set ns = namespace(last_change_ts=0) %}
            {% if inputs.master_smart_window != '' and is_state(inputs.master_smart_window, 'off') %}
              {% set sw = expand([inputs.master_smart_window]) | first %}
              {% if sw is not none and sw.last_changed is defined and sw.last_changed is not none %}
                {% set sw_ts = as_timestamp(sw.last_changed, 0) | float(0) %}
                {% if sw_ts > 946684800 and sw_ts <= now_ts %}
                  {% set ns.last_change_ts = [ns.last_change_ts, sw_ts] | max %}
                {% endif %}
              {% endif %}
            {% endif %}
            {% if ns.last_change_ts > 0 %}
              {{ (now_ts - ns.last_change_ts) < ((inputs.window_heat_delay | float(0)) * 60) }}
            {% else %}
              {{ false }}
            {% endif %}
          {% endif %}
        {% else %}
          {{ false }}
        {% endif %}

      # ===== GROUP 3: DEMAND CALCULATION =====
      eco_temp: >
        {% if inputs.eco_temp_input != "" %}
          {{ states(inputs.eco_temp_input) | float(inputs.eco_temp_fixed) }}
        {% else %}
          {{ inputs.eco_temp_fixed }}
        {% endif %}
      away_temp: >
        {% if inputs.away_temp_input != "" %}
          {{ states(inputs.away_temp_input) | float(inputs.away_temp_fixed) }}
        {% else %}
          {{ inputs.away_temp_fixed }}
        {% endif %}
      master_comfort_temp: >
        {% if inputs.master_comfort_input != "" %}
          {{ states(inputs.master_comfort_input) | float(inputs.master_comfort_fixed) }}
        {% else %}
          {{ inputs.master_comfort_fixed }}
        {% endif %}
      room2_comfort_temp_for_demand: >
        {% if inputs.room2_comfort_input != "" %}
          {{ states(inputs.room2_comfort_input) | float(inputs.room2_comfort_fixed) }}
        {% else %}
          {{ inputs.room2_comfort_fixed }}
        {% endif %}
      room3_comfort_temp_for_demand: >
        {% if inputs.room3_comfort_input != "" %}
          {{ states(inputs.room3_comfort_input) | float(inputs.room3_comfort_fixed) }}
        {% else %}
          {{ inputs.room3_comfort_fixed }}
        {% endif %}
      room4_comfort_temp_for_demand: >
        {% if inputs.room4_comfort_input != "" %}
          {{ states(inputs.room4_comfort_input) | float(inputs.room4_comfort_fixed) }}
        {% else %}
          {{ inputs.room4_comfort_fixed }}
        {% endif %}
      room5_comfort_temp_for_demand: >
        {% if inputs.room5_comfort_input != "" %}
          {{ states(inputs.room5_comfort_input) | float(inputs.room5_comfort_fixed) }}
        {% else %}
          {{ inputs.room5_comfort_fixed }}
        {% endif %}
      master_demand: >
        {% if master_schedule_active or master_presence_detected %}
          {{ master_comfort_temp }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room_global_fallback_demand: >
        {% set ns = namespace(active=false) %}
        {% for ent in inputs.away_mode_boolean %}
          {% if ent is string and ent != '' and is_state(ent, 'on') %}
            {% set ns.active = true %}
          {% endif %}
        {% endfor %}
        {% if ns.active %}
          {{ away_temp }}
        {% else %}
          {{ eco_temp }}
        {% endif %}
      room2_demand: >
        {% set room2_sched = room2_schedule_active_for_demand | string | lower %}
        {% set room2_pres = room2_presence_for_demand | string | lower %}
        {% set room2_local_override = (room2_sched in ['true', 'on', '1']) or (room2_pres in ['true', 'on', '1']) %}
        {% if (inputs.room2_enabled | string | lower) in ['true', 'on', '1'] and room2_local_override %}
          {{ room2_comfort_temp_for_demand }}
        {% else %}
          {{ room_global_fallback_demand }}
        {% endif %}
      room3_demand: >
        {% set room3_sched = room3_schedule_active_for_demand | string | lower %}
        {% set room3_pres = room3_presence_for_demand | string | lower %}
        {% set room3_local_override = (room3_sched in ['true', 'on', '1']) or (room3_pres in ['true', 'on', '1']) %}
        {% if (inputs.room3_enabled | string | lower) in ['true', 'on', '1'] and room3_local_override %}
          {{ room3_comfort_temp_for_demand }}
        {% else %}
          {{ room_global_fallback_demand }}
        {% endif %}
      room4_demand: >
        {% set room4_sched = room4_schedule_active_for_demand | string | lower %}
        {% set room4_pres = room4_presence_for_demand | string | lower %}
        {% set room4_local_override = (room4_sched in ['true', 'on', '1']) or (room4_pres in ['true', 'on', '1']) %}
        {% if (inputs.room4_enabled | string | lower) in ['true', 'on', '1'] and room4_local_override %}
          {{ room4_comfort_temp_for_demand }}
        {% else %}
          {{ room_global_fallback_demand }}
        {% endif %}
      room5_demand: >
        {% set room5_sched = room5_schedule_active_for_demand | string | lower %}
        {% set room5_pres = room5_presence_for_demand | string | lower %}
        {% set room5_local_override = (room5_sched in ['true', 'on', '1']) or (room5_pres in ['true', 'on', '1']) %}
        {% if (inputs.room5_enabled | string | lower) in ['true', 'on', '1'] and room5_local_override %}
          {{ room5_comfort_temp_for_demand }}
        {% else %}
          {{ room_global_fallback_demand }}
        {% endif %}
      global_max_demand: >
        {{ [
          master_demand | float(eco_temp),
          room2_demand | float(eco_temp),
          room3_demand | float(eco_temp),
          room4_demand | float(eco_temp),
          room5_demand | float(eco_temp)
        ] | max }}

      # ===== GROUP 4: TARGET CALCULATION =====
      away_mode_helper_set: "{{ inputs.away_mode_boolean | length > 0 }}"
      away_mode_entity_on: >
        {% if away_mode_helper_set %}
          {% set ns = namespace(active=false) %}
          {% for ent in inputs.away_mode_boolean %}
            {% if ent is string and ent != '' and is_state(ent, 'on') %}
              {% set ns.active = true %}
            {% endif %}
          {% endfor %}
          {{ ns.active | bool(false) }}
        {% else %}
          {{ false }}
        {% endif %}
      panic_mode_active: >
        {% if inputs.panic_mode_enabled != '' %}
          {{ is_state(inputs.panic_mode_enabled, 'on') }}
        {% else %}
          {{ false }}
        {% endif %}
      away_mode_should_be_active: false
      master_target_temp: >
        {% if panic_mode_active | bool(false) %}
          {{ master_comfort_temp }}
        {% elif (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
          {{ away_temp }}
        {% else %}
          {{ global_max_demand }}
        {% endif %}
      master_humidity: >
        {% if inputs.master_humidity_sensor != "" %}
          {{ states(inputs.master_humidity_sensor) | float(50) }}
        {% else %}
          50
        {% endif %}
      humidity_compensation_active: >
        {{ inputs.enable_humidity_compensation and master_humidity > 60 and master_humidity < 65 }}
      master_target_with_humidity: >
        {% if humidity_compensation_active %}
          {{ master_target_temp - 0.5 }}
        {% else %}
          {{ master_target_temp }}
        {% endif %}

      # ===== GROUP 5: SAFETY & STATUS =====
      outdoor_temp_sensor_configured: >
        {{ inputs.outdoor_temp_sensor != '' }}
      outdoor_temp: >
        {% set raw = states(inputs.outdoor_temp_sensor) if outdoor_temp_sensor_configured else '' %}
        {% if outdoor_temp_sensor_configured and raw not in ['unknown', 'unavailable', 'none', ''] %}
          {{ raw | float(0) }}
        {% else %}
          0
        {% endif %}
      outdoor_temp_valid: >
        {% set raw = states(inputs.outdoor_temp_sensor) if outdoor_temp_sensor_configured else '' %}
        {{ outdoor_temp_sensor_configured and (raw not in ['unknown', 'unavailable', 'none', '']) }}
      summer_mode: >
        {% if outdoor_temp_valid %}
          {% set current_outdoor = outdoor_temp | float(0) %}
          {% set threshold_on = inputs.summer_threshold | float(18) %}
          {% set threshold_off = threshold_on - (inputs.summer_hysteresis | float(1.0)) %}
          {% set master_set = state_attr(inputs.master_climate, 'temperature') | float(999) if inputs.master_climate != '' else 999 %}
          {% set master_min = state_attr(inputs.master_climate, 'min_temp') | float(inputs.min_trv_temp | float(12)) if inputs.master_climate != '' else (inputs.min_trv_temp | float(12)) %}
          {% set summer_state_guess = inputs.master_climate != '' and (master_set <= (master_min + 0.2)) %}
          {% if current_outdoor > threshold_on %}
            {{ true }}
          {% elif current_outdoor < threshold_off %}
            {{ false }}
          {% else %}
            {{ summer_state_guess }}
          {% endif %}
        {% else %}
          {{ false }}
        {% endif %}
      window_reheat_blocked: "{{ (master_window_recently_closed | bool(false)) and (outdoor_temp_valid | bool(false)) and ((outdoor_temp | float(0)) >= 5) }}"
      master_target_final: >
        {% if master_window_open_too_long or window_reheat_blocked %}
          {{ inputs.min_trv_temp }}
        {% else %}
          {{ master_target_with_humidity }}
        {% endif %}
      master_climate_available: >
        {{ inputs.master_climate != "" and states(inputs.master_climate) not in ['unavailable', 'unknown'] }}
      master_sensor_available: "{{ master_climate_available }}"

      # ===== GROUP 6: WRITE LOGIC FLAGS =====
      safe_mode_blocking: false
  # ===== STEP 0.01: HELPER INPUT DEBOUNCE =====
  - choose:
      - conditions:
          - "{{ helper_input_trigger }}"
        sequence:
          - delay:
              seconds: "{{ helper_input_settle_seconds }}"
          - choose:
              - conditions:
                  - "{{ helper_input_trigger_entity != '' }}"
                  - >
                    {% set so = expand([helper_input_trigger_entity]) | first %}
                    {% if so is not none and so.last_changed is defined %}
                      {{ as_timestamp(so.last_changed, 0) > ((helper_input_trigger_ts | float(0)) + 0.5) }}
                    {% else %}
                      {{ false }}
                    {% endif %}
                sequence:
                  - stop: "Neuere Helper-Ã„nderung erkannt - veralteten Lauf beendet."

    # ========== ROOM 2 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room2_enabled }}"
        sequence:
          - variables:
              room2_schedule_active: >
                {% if inputs.room2_schedule != "" %}
                  {{ is_state(inputs.room2_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room2_presence: >
                {% if inputs.room2_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room2_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room2_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room2_window_open: >
                {{ (is_state(inputs.room2_window, 'on') if inputs.room2_window != '' else false) or (is_state(inputs.room2_smart_window, 'on') if inputs.room2_smart_window != '' else false) }}
              room2_comfort_temp: >
                {% if inputs.room2_comfort_input != "" %}
                  {{ states(inputs.room2_comfort_input) | float(inputs.room2_comfort_fixed) }}
                {% else %}
                  {{ inputs.room2_comfort_fixed }}
                {% endif %}
              room2_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input %}
                  {{ room2_comfort_temp }}
                {% elif room2_schedule_active or room2_presence %}
                  {{ room2_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room2_final_temp: >
                {% if room2_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room2_schedule_active or room2_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room2_target_temp }}
                {% endif %}
              room2_climate_state: >
                {% if inputs.room2_climate != "" %}
                  {{ states(inputs.room2_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room2_climate_available: >
                {{ inputs.room2_climate != '' and states(inputs.room2_climate) not in ['unknown', 'unavailable'] }}
              room2_current_setpoint: >
                {% if room2_climate_available %}
                  {{ state_attr(inputs.room2_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room2_current_temp: >
                {% if inputs.room2_temp_sensor != "" %}
                  {% if room2_climate_available %}
                    {{ states(inputs.room2_temp_sensor) | float(state_attr(inputs.room2_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room2_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room2_climate_available %}
                  {{ state_attr(inputs.room2_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room2_temp_diff: >
                {{ (room2_final_temp - room2_current_setpoint) | abs }}
              room2_setpoint_threshold: 0.1
              force_room2_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room2_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room2_climate != '' and states(inputs.room2_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room2_temp_diff > room2_setpoint_threshold) or force_room2_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room2_climate }}"
                    data:
                      temperature: "{{ room2_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 3 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room3_enabled }}"
        sequence:
          - variables:
              room3_schedule_active: >
                {% if inputs.room3_schedule != "" %}
                  {{ is_state(inputs.room3_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room3_presence: >
                {% if inputs.room3_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room3_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room3_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room3_window_open: >
                {{ (is_state(inputs.room3_window, 'on') if inputs.room3_window != '' else false) or (is_state(inputs.room3_smart_window, 'on') if inputs.room3_smart_window != '' else false) }}
              room3_comfort_temp: >
                {% if inputs.room3_comfort_input != "" %}
                  {{ states(inputs.room3_comfort_input) | float(inputs.room3_comfort_fixed) }}
                {% else %}
                  {{ inputs.room3_comfort_fixed }}
                {% endif %}
              room3_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input %}
                  {{ room3_comfort_temp }}
                {% elif room3_schedule_active or room3_presence %}
                  {{ room3_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room3_final_temp: >
                {% if room3_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room3_schedule_active or room3_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room3_target_temp }}
                {% endif %}
              room3_climate_state: >
                {% if inputs.room3_climate != "" %}
                  {{ states(inputs.room3_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room3_climate_available: >
                {{ inputs.room3_climate != '' and states(inputs.room3_climate) not in ['unknown', 'unavailable'] }}
              room3_current_setpoint: >
                {% if room3_climate_available %}
                  {{ state_attr(inputs.room3_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room3_current_temp: >
                {% if inputs.room3_temp_sensor != "" %}
                  {% if room3_climate_available %}
                    {{ states(inputs.room3_temp_sensor) | float(state_attr(inputs.room3_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room3_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room3_climate_available %}
                  {{ state_attr(inputs.room3_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room3_temp_diff: >
                {{ (room3_final_temp - room3_current_setpoint) | abs }}
              room3_setpoint_threshold: 0.1
              force_room3_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room3_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room3_climate != '' and states(inputs.room3_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room3_temp_diff > room3_setpoint_threshold) or force_room3_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room3_climate }}"
                    data:
                      temperature: "{{ room3_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 4 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room4_enabled }}"
        sequence:
          - variables:
              room4_schedule_active: >
                {% if inputs.room4_schedule != "" %}
                  {{ is_state(inputs.room4_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room4_presence: >
                {% if inputs.room4_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room4_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room4_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room4_window_open: >
                {{ (is_state(inputs.room4_window, 'on') if inputs.room4_window != '' else false) or (is_state(inputs.room4_smart_window, 'on') if inputs.room4_smart_window != '' else false) }}
              room4_comfort_temp: >
                {% if inputs.room4_comfort_input != "" %}
                  {{ states(inputs.room4_comfort_input) | float(inputs.room4_comfort_fixed) }}
                {% else %}
                  {{ inputs.room4_comfort_fixed }}
                {% endif %}
              room4_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input %}
                  {{ room4_comfort_temp }}
                {% elif room4_schedule_active or room4_presence %}
                  {{ room4_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room4_final_temp: >
                {% if room4_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room4_schedule_active or room4_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room4_target_temp }}
                {% endif %}
              room4_climate_state: >
                {% if inputs.room4_climate != "" %}
                  {{ states(inputs.room4_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room4_climate_available: >
                {{ inputs.room4_climate != '' and states(inputs.room4_climate) not in ['unknown', 'unavailable'] }}
              room4_current_setpoint: >
                {% if room4_climate_available %}
                  {{ state_attr(inputs.room4_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room4_current_temp: >
                {% if inputs.room4_temp_sensor != "" %}
                  {% if room4_climate_available %}
                    {{ states(inputs.room4_temp_sensor) | float(state_attr(inputs.room4_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room4_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room4_climate_available %}
                  {{ state_attr(inputs.room4_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room4_temp_diff: >
                {{ (room4_final_temp - room4_current_setpoint) | abs }}
              room4_setpoint_threshold: 0.1
              force_room4_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room4_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room4_climate != '' and states(inputs.room4_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room4_temp_diff > room4_setpoint_threshold) or force_room4_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room4_climate }}"
                    data:
                      temperature: "{{ room4_final_temp }}"
                    continue_on_error: true

  # ========== ROOM 5 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.room5_enabled }}"
        sequence:
          - variables:
              room5_schedule_active: >
                {% if inputs.room5_schedule != "" %}
                  {{ is_state(inputs.room5_schedule, 'on') }}
                {% else %}
                  {{ false }}
                {% endif %}
              room5_presence: >
                {% if inputs.room5_presence_sensors | length == 0 %}
                  {{ false }}
                {% else %}
                  {% set sensors = expand(inputs.room5_presence_sensors) | selectattr('last_changed', 'defined') | list %}
                  {% if sensors | length == 0 %}
                    {{ false }}
                  {% else %}
                  {% set any_on = sensors | selectattr('state', 'eq', 'on') | list | length > 0 %}
                  {% set ns = namespace(active=false) %}
                  {% for s in sensors %}
                    {% if s.state == 'on' %}
                      {% set s_changed = s.last_changed | as_datetime %}
                      {% if s_changed is not none and ((as_timestamp(now()) - as_timestamp(s_changed, as_timestamp(now()))) >= (inputs.presence_activation_delay | float(0) * 60)) %}
                        {% set ns.active = true %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.active %}
                    {{ true }}
                  {% elif not any_on %}
                    {% set last_changes = sensors | map(attribute='last_changed') | list %}
                    {% if last_changes | length > 0 %}
                      {% set last_change = last_changes | max %}
                      {% set last_change_dt = last_change | as_datetime %}
                      {% if last_change_dt is not none %}
                        {{ (as_timestamp(now()) - as_timestamp(last_change_dt, as_timestamp(now()))) < (inputs.room5_presence_delay | float(0) * 60) }}
                      {% else %}
                        {{ false }}
                      {% endif %}
                    {% else %}
                      {{ false }}
                    {% endif %}
                  {% else %}
                    {{ false }}
                  {% endif %}
                  {% endif %}
                {% endif %}
              room5_window_open: >
                {{ (is_state(inputs.room5_window, 'on') if inputs.room5_window != '' else false) or (is_state(inputs.room5_smart_window, 'on') if inputs.room5_smart_window != '' else false) }}
              room5_comfort_temp: >
                {% if inputs.room5_comfort_input != "" %}
                  {{ states(inputs.room5_comfort_input) | float(inputs.room5_comfort_fixed) }}
                {% else %}
                  {{ inputs.room5_comfort_fixed }}
                {% endif %}
              room5_target_temp: >
                {% if (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) %}
                  {{ away_temp }}
                {% elif helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input %}
                  {{ room5_comfort_temp }}
                {% elif room5_schedule_active or room5_presence %}
                  {{ room5_comfort_temp }}
                {% else %}
                  {{ eco_temp }}
                {% endif %}
              room5_final_temp: >
                {% if room5_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (room5_schedule_active or room5_presence or (helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input)) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ room5_target_temp }}
                {% endif %}
              room5_climate_state: >
                {% if inputs.room5_climate != "" %}
                  {{ states(inputs.room5_climate) }}
                {% else %}
                  unknown
                {% endif %}
              room5_climate_available: >
                {{ inputs.room5_climate != '' and states(inputs.room5_climate) not in ['unknown', 'unavailable'] }}
              room5_current_setpoint: >
                {% if room5_climate_available %}
                  {{ state_attr(inputs.room5_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              room5_current_temp: >
                {% if inputs.room5_temp_sensor != "" %}
                  {% if room5_climate_available %}
                    {{ states(inputs.room5_temp_sensor) | float(state_attr(inputs.room5_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.room5_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif room5_climate_available %}
                  {{ state_attr(inputs.room5_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              room5_temp_diff: >
                {{ (room5_final_temp - room5_current_setpoint) | abs }}
              room5_setpoint_threshold: 0.1
              force_room5_setpoint_sync: >
                {{ helper_input_trigger and helper_input_trigger_entity == inputs.room5_comfort_input }}
          - choose:
              - conditions:
                  - "{{ inputs.room5_climate != '' and states(inputs.room5_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ (room5_temp_diff > room5_setpoint_threshold) or force_room5_setpoint_sync }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.room5_climate }}"
                    data:
                      temperature: "{{ room5_final_temp }}"
                    continue_on_error: true

  # ========== FOLLOWER 1 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.follower1_enabled }}"
        sequence:
          - variables:
              follower1_window_open: >
                {{ (is_state(inputs.follower1_window, 'on') if inputs.follower1_window != '' else false) }}
              follower1_target_temp: >
                {% set raw_target = (master_target_final | float(inputs.min_trv_temp)) + (inputs.follower1_offset | float(-2.0)) %}
                {{ [inputs.min_trv_temp | float(12), raw_target] | max }}
              follower1_final_temp: >
                {% if follower1_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (master_schedule_active or master_presence_detected) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ follower1_target_temp }}
                {% endif %}
              follower1_climate_available: >
                {{ inputs.follower1_climate != '' and states(inputs.follower1_climate) not in ['unknown', 'unavailable'] }}
              follower1_current_setpoint: >
                {% if follower1_climate_available %}
                  {{ state_attr(inputs.follower1_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              follower1_current_temp: >
                {% if inputs.follower1_temp_sensor != "" %}
                  {% if follower1_climate_available %}
                    {{ states(inputs.follower1_temp_sensor) | float(state_attr(inputs.follower1_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.follower1_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif follower1_climate_available %}
                  {{ state_attr(inputs.follower1_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              follower1_temp_diff: >
                {{ (follower1_final_temp - follower1_current_setpoint) | abs }}
          - choose:
              - conditions:
                  - "{{ inputs.follower1_climate != '' and states(inputs.follower1_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ follower1_temp_diff > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.follower1_climate }}"
                    data:
                      temperature: "{{ follower1_final_temp }}"
                    continue_on_error: true

  # ========== FOLLOWER 2 LOGIC ==========
  - choose:
      - conditions: "{{ inputs.follower2_enabled }}"
        sequence:
          - variables:
              follower2_window_open: >
                {{ (is_state(inputs.follower2_window, 'on') if inputs.follower2_window != '' else false) }}
              follower2_target_temp: >
                {% set raw_target = (master_target_final | float(inputs.min_trv_temp)) + (inputs.follower2_offset | float(-2.0)) %}
                {{ [inputs.min_trv_temp | float(12), raw_target] | max }}
              follower2_final_temp: >
                {% if follower2_window_open %}
                  {{ inputs.min_trv_temp }}
                {% elif summer_mode and not (master_schedule_active or master_presence_detected) %}
                  {{ inputs.min_trv_temp }}
                {% else %}
                  {{ follower2_target_temp }}
                {% endif %}
              follower2_climate_available: >
                {{ inputs.follower2_climate != '' and states(inputs.follower2_climate) not in ['unknown', 'unavailable'] }}
              follower2_current_setpoint: >
                {% if follower2_climate_available %}
                  {{ state_attr(inputs.follower2_climate, 'temperature') | float(0) }}
                {% else %}
                  0
                {% endif %}
              follower2_current_temp: >
                {% if inputs.follower2_temp_sensor != "" %}
                  {% if follower2_climate_available %}
                    {{ states(inputs.follower2_temp_sensor) | float(state_attr(inputs.follower2_climate, 'current_temperature') | float(21)) }}
                  {% else %}
                    {{ states(inputs.follower2_temp_sensor) | float(21) }}
                  {% endif %}
                {% elif follower2_climate_available %}
                  {{ state_attr(inputs.follower2_climate, 'current_temperature') | float(21) }}
                {% else %}
                  21
                {% endif %}
              follower2_temp_diff: >
                {{ (follower2_final_temp - follower2_current_setpoint) | abs }}
          - choose:
              - conditions:
                  - "{{ inputs.follower2_climate != '' and states(inputs.follower2_climate) not in ['unavailable', 'unknown'] }}"
                  - "{{ follower2_temp_diff > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.follower2_climate }}"
                    data:
                      temperature: "{{ follower2_final_temp }}"
                    continue_on_error: true

  # ===== STEP 5.5: MASTER TARGET AGGREGATION & WRITE =====
  - choose:
      - conditions:
          - "{{ master_sensor_available and not safe_mode_blocking }}"
          - "{{ master_climate_available }}"
        sequence:
          - variables:
              # === SCOPE FIX: Ensure room variables exist ===
              room2_final_temp: "{{ room2_final_temp | default(0) }}"
              room2_current_temp: "{{ room2_current_temp | default(0) }}"
              room2_schedule_active: "{{ room2_schedule_active | default(false) }}"
              room2_presence: "{{ room2_presence | default(false) }}"
              room3_final_temp: "{{ room3_final_temp | default(0) }}"
              room3_current_temp: "{{ room3_current_temp | default(0) }}"
              room3_schedule_active: "{{ room3_schedule_active | default(false) }}"
              room3_presence: "{{ room3_presence | default(false) }}"
              room4_final_temp: "{{ room4_final_temp | default(0) }}"
              room4_current_temp: "{{ room4_current_temp | default(0) }}"
              room4_schedule_active: "{{ room4_schedule_active | default(false) }}"
              room4_presence: "{{ room4_presence | default(false) }}"
              room5_final_temp: "{{ room5_final_temp | default(0) }}"
              room5_current_temp: "{{ room5_current_temp | default(0) }}"
              room5_schedule_active: "{{ room5_schedule_active | default(false) }}"
              room5_presence: "{{ room5_presence | default(false) }}"
              # === Continue with existing variables ===
              room_window_trigger_event: >
                {% if trigger is defined and trigger is not none and trigger.id is defined %}
                  {{ trigger.id in ['room2_window_change', 'room3_window_change', 'room4_window_change', 'room5_window_change'] }}
                {% else %}
                  {{ false }}
                {% endif %}
              master_forced_min_active: >
                {{ (master_window_open_too_long | bool(false)) or (window_reheat_blocked | bool(false)) }}
              away_mode_active_effective: >
                {{ (away_mode_should_be_active | bool(false)) or (away_mode_entity_on | bool(false)) }}
              master_safety_floor: >
                {% if away_mode_active_effective | bool(false) %}
                  {{ inputs.min_trv_temp | float(12) }}
                {% else %}
                  {{ eco_temp | float(19) }}
                {% endif %}
              isolated_room_demand_targets: >
                {% set ns = namespace(vals=[]) %}

                {# Room 2 - Isolated only, active heating check #}
                {% if inputs.room2_enabled and inputs.room2_climate != '' and room2_final_temp is defined and room2_current_temp is defined %}
                  {% set room2_effective_target = room2_final_temp | float(0) %}
                  {% set room2_needs_heat = room2_effective_target > ((room2_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room2_active = ((room2_schedule_active | default(false)) | bool(false)) or ((room2_presence | default(false)) | bool(false)) %}
                  {% if room2_needs_heat and room2_active %}
                    {% set ns.vals = ns.vals + [room2_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 3 - Isolated only, active heating check #}
                {% if inputs.room3_enabled and inputs.room3_climate != '' and room3_final_temp is defined and room3_current_temp is defined %}
                  {% set room3_effective_target = room3_final_temp | float(0) %}
                  {% set room3_needs_heat = room3_effective_target > ((room3_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room3_active = ((room3_schedule_active | default(false)) | bool(false)) or ((room3_presence | default(false)) | bool(false)) %}
                  {% if room3_needs_heat and room3_active %}
                    {% set ns.vals = ns.vals + [room3_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 4 - Isolated only, active heating check #}
                {% if inputs.room4_enabled and inputs.room4_climate != '' and room4_final_temp is defined and room4_current_temp is defined %}
                  {% set room4_effective_target = room4_final_temp | float(0) %}
                  {% set room4_needs_heat = room4_effective_target > ((room4_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room4_active = ((room4_schedule_active | default(false)) | bool(false)) or ((room4_presence | default(false)) | bool(false)) %}
                  {% if room4_needs_heat and room4_active %}
                    {% set ns.vals = ns.vals + [room4_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Room 5 - Isolated only, active heating check #}
                {% if inputs.room5_enabled and inputs.room5_climate != '' and room5_final_temp is defined and room5_current_temp is defined %}
                  {% set room5_effective_target = room5_final_temp | float(0) %}
                  {% set room5_needs_heat = room5_effective_target > ((room5_current_temp | float(0)) + (inputs.hysteresis | float(0.6))) %}
                  {% set room5_active = ((room5_schedule_active | default(false)) | bool(false)) or ((room5_presence | default(false)) | bool(false)) %}
                  {% if room5_needs_heat and room5_active %}
                    {% set ns.vals = ns.vals + [room5_effective_target] %}
                  {% endif %}
                {% endif %}

                {# Follower rooms NEVER included in demand targets #}
                {{ ns.vals }}
              master_presence_priority_active: >
                {% if inputs.master_presence_priority_helper != '' %}
                  {{ is_state(inputs.master_presence_priority_helper, 'on') }}
                {% else %}
                  {{ inputs.enable_master_presence_priority | bool(false) }}
                {% endif %}
              master_base_required_target: >
                {% set demand_targets = isolated_room_demand_targets | default([]) %}
                {% if master_forced_min_active | bool(false) %}
                  {% set target_raw = master_safety_floor | float(12) %}
                {% elif (master_presence_priority_active | bool(false)) and ((master_presence_detected | default(false)) | bool(false)) %}
                  {% set target_raw = master_target_final | float(0) %}
                {% elif demand_targets | length > 0 %}
                  {% set max_room_target = (demand_targets | max | float(0)) %}
                  {% set target_raw = [master_target_final | float(0), max_room_target] | max %}
                {% else %}
                  {% set target_raw = master_target_final | float(0) %}
                {% endif %}
                {{ [target_raw | float(0), master_safety_floor | float(12)] | max }}
              weather_compensation_add: >
                {% if not (inputs.enable_weather_compensation | bool(false)) %}
                  0.0
                {% elif not (outdoor_temp_valid | bool(false)) %}
                  0.0
                {% elif (outdoor_temp | float(0)) <= 0 %}
                  2.0
                {% elif (outdoor_temp | float(0)) >= 10 %}
                  0.0
                {% else %}
                  {% set linear_boost = ((10 - (outdoor_temp | float(0))) / 10) * 2 %}
                  {{ [[linear_boost, 0.0] | max, 2.0] | min }}
                {% endif %}
              master_required_target_raw: >
                {% if master_forced_min_active | bool(false) %}
                  {{ inputs.min_trv_temp | float(12) }}
                {% else %}
                  {{ [((master_base_required_target | float(0)) + (weather_compensation_add | float(0))), (master_safety_floor | float(12))] | max }}
                {% endif %}
              master_min: "{{ state_attr(inputs.master_climate, 'min_temp') | float(inputs.min_trv_temp | float(12)) }}"
              master_max: "{{ state_attr(inputs.master_climate, 'max_temp') | float(30) }}"
              master_required_target: >
                {% set hi = [master_required_target_raw | float(0), master_max | float(30)] | min %}
                {{ [hi, master_min | float(inputs.min_trv_temp | float(12))] | max }}
              # Room boost detection with anti-overshoot hysteresis
              room_boost_enabled_effective: >
                {{ (inputs.enable_room_boost | bool(false)) and (inputs.room_boost_amount | float(0) > 0) and (not (master_forced_min_active | bool(false))) and (not (away_mode_active_effective | bool(false))) }}
              room2_needs_boost: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room2_enabled | bool(false)) and inputs.room2_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room2_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room2_demand | float(0) %}
                    {% set threshold = inputs.room_boost_threshold | float(0.5) %}
                    {% set delta = room_target - room_current %}
                    {{ delta > threshold }}
                  {% else %}
                    {{ false }}
                  {% endif %}
                {% else %}
                  {{ false }}
                {% endif %}
              room2_boost_deactivate: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room2_enabled | bool(false)) and inputs.room2_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room2_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room2_demand | float(0) %}
                    {% set delta = room_target - room_current %}
                    {{ delta <= 0.5 }}
                  {% else %}
                    {{ true }}
                  {% endif %}
                {% else %}
                  {{ true }}
                {% endif %}
              room3_needs_boost: >
                {# USE ROBUST CHECK to match room3_demand logic #}
                {% if room_boost_enabled_effective | bool(false) and ((inputs.room3_enabled | string | lower) in ['true', 'on', '1']) and inputs.room3_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room3_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room3_demand | float(0) %}
                    {% set threshold = inputs.room_boost_threshold | float(0.5) %}
                    {% set delta = room_target - room_current %}
                    {{ delta > threshold }}
                  {% else %}
                    {{ false }}
                  {% endif %}
                {% else %}
                  {{ false }}
                {% endif %}
              room3_boost_deactivate: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room3_enabled | bool(false)) and inputs.room3_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room3_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room3_demand | float(0) %}
                    {% set delta = room_target - room_current %}
                    {{ delta <= 0.5 }}
                  {% else %}
                    {{ true }}
                  {% endif %}
                {% else %}
                  {{ true }}
                {% endif %}
              room4_needs_boost: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room4_enabled | bool(false)) and inputs.room4_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room4_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room4_demand | float(0) %}
                    {% set threshold = inputs.room_boost_threshold | float(0.5) %}
                    {% set delta = room_target - room_current %}
                    {{ delta > threshold }}
                  {% else %}
                    {{ false }}
                  {% endif %}
                {% else %}
                  {{ false }}
                {% endif %}
              room4_boost_deactivate: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room4_enabled | bool(false)) and inputs.room4_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room4_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room4_demand | float(0) %}
                    {% set delta = room_target - room_current %}
                    {{ delta <= 0.5 }}
                  {% else %}
                    {{ true }}
                  {% endif %}
                {% else %}
                  {{ true }}
                {% endif %}
              room5_needs_boost: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room5_enabled | bool(false)) and inputs.room5_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room5_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room5_demand | float(0) %}
                    {% set threshold = inputs.room_boost_threshold | float(0.5) %}
                    {% set delta = room_target - room_current %}
                    {{ delta > threshold }}
                  {% else %}
                    {{ false }}
                  {% endif %}
                {% else %}
                  {{ false }}
                {% endif %}
              room5_boost_deactivate: >
                {% if room_boost_enabled_effective | bool(false) and (inputs.room5_enabled | bool(false)) and inputs.room5_temp_sensor != '' %}
                  {% set room_raw = states(inputs.room5_temp_sensor) %}
                  {% if room_raw not in ['unknown', 'unavailable', 'none', ''] %}
                    {% set room_current = room_raw | float(0) %}
                    {% set room_target = room5_demand | float(0) %}
                    {% set delta = room_target - room_current %}
                    {{ delta <= 0.5 }}
                  {% else %}
                    {{ true }}
                  {% endif %}
                {% else %}
                  {{ true }}
                {% endif %}
              any_room_needs_boost: >
                {{
                  (room2_needs_boost | bool(false)) or
                  (room3_needs_boost | bool(false)) or
                  (room4_needs_boost | bool(false)) or
                  (room5_needs_boost | bool(false))
                }}
              all_rooms_boost_deactivate: >
                {{
                  (room2_boost_deactivate | bool(true)) and
                  (room3_boost_deactivate | bool(true)) and
                  (room4_boost_deactivate | bool(true)) and
                  (room5_boost_deactivate | bool(true))
                }}
              master_boost_active: >
                {{
                  (room_boost_enabled_effective | bool(false)) and
                  (any_room_needs_boost | bool(false)) and
                  (not (all_rooms_boost_deactivate | bool(true)))
                }}
              master_boost_amount: >
                {% if master_boost_active | bool(false) %}
                  {{ inputs.room_boost_amount | float(2.0) }}
                {% else %}
                  {{ 0.0 }}
                {% endif %}
              master_required_target_with_boost: >
                {% set base = master_required_target | float(0) %}
                {% set boost = master_boost_amount | float(0) %}
                {% set with_boost = base + boost %}
                {{ [with_boost, master_max | float(30)] | min }}
              master_set_now: "{{ state_attr(inputs.master_climate, 'temperature') | float(0) }}"
              master_target_delta_abs: "{{ ((master_required_target_with_boost | float(0)) - (master_set_now | float(0))) | abs }}"
              master_needs_global_boost: >
                {{ (not (away_mode_active_effective | bool(false))) and ((master_set_now | float(0)) < ((global_max_demand | float(0)) - 0.1)) }}
              master_needs_global_drop: >
                {{ (not (away_mode_active_effective | bool(false))) and ((master_set_now | float(0)) > ((global_max_demand | float(0)) + 0.1)) }}
              master_significant_drop: >
                {{ ((master_set_now | float(0)) - (master_required_target_with_boost | float(0))) > 2.0 }}
              effective_max_changes_per_hour: "{{ [inputs.max_changes_per_hour | float(3), 2] | max }}"
              master_change_min_interval_min_step55: "{{ 60 / (effective_max_changes_per_hour | float(3)) }}"
              # API Write Tracking: Letzter erfolgreicher Write an Master-Thermostat
              last_write_timestamp: >
                {% set helper_state = states(inputs.master_last_write_helper) %}
                {% if helper_state in ['unknown', 'unavailable', ''] %}
                  {{ now() - timedelta(hours=24) }}
                {% else %}
                  {% set parsed = helper_state | as_datetime %}
                  {% if parsed is not none %}
                    {{ parsed }}
                  {% else %}
                    {{ now() - timedelta(hours=24) }}
                  {% endif %}
                {% endif %}
              master_last_update_age_step55: >
                {% set helper = inputs.master_last_write_helper %}
                {% if helper != '' and states(helper) not in ['unavailable', 'unknown', ''] %}
                  {% set last_write_str = states(helper) %}
                  {% set last_write_ts = as_timestamp(strptime(last_write_str, '%Y-%m-%d %H:%M:%S')) | float(0) %}
                  {% set now_ts = as_timestamp(now()) | float(0) %}
                  {{ now_ts - last_write_ts }}
                {% else %}
                  {{ 999999 }}
                {% endif %}
              master_change_cooldown_ok_step55: >
                {{ (master_last_update_age_step55 | float(999999)) >= (3600 / (effective_max_changes_per_hour | float(3))) }}
              master_needs_raise: >
                {{ (master_required_target_with_boost | float(0)) > ((master_set_now | float(0)) + (inputs.hysteresis | float(0.6))) }}
              master_excessively_high: >
                {{ master_needs_global_drop | bool(false) }}
              master_stuck_protection_active: >
                {{ (master_needs_raise | bool(false)) and ((master_last_update_age_step55 | float(0)) >= 1800) }}
              master_raise_allowed: >
                {{ (master_needs_raise | bool(false)) and ((master_change_cooldown_ok_step55 | bool(false)) or ((master_target_delta_abs | float(0)) > 3.0) or (master_stuck_protection_active | bool(false))) }}
              master_drop_allowed: >
                {{ (master_needs_global_drop | bool(false)) and (master_change_cooldown_ok_step55 | bool(false)) }}
              master_write_allowed: >
                {{ (not (room_window_trigger_event | bool(false))) and (not (master_forced_min_active | bool(false))) and ((master_raise_allowed | bool(false)) or (master_drop_allowed | bool(false))) }}
          - choose:
              # PATH A (CRITICAL): forced-min writes bypass cooldown
              - conditions:
                  - "{{ master_forced_min_active | bool(false) }}"
                  - "{{ (master_target_delta_abs | float(0)) > 0.5 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target_with_boost }}"
                    continue_on_error: true
                  - delay:
                      seconds: 2
                  - condition: template
                    value_template: >
                      {{ ((state_attr(inputs.master_climate, 'temperature') | float(0)) - (master_required_target_with_boost | float(0))) | abs <= 0.11 }}
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
              # PATH B (CRITICAL): highest bidder boost or significant drop bypasses cooldown
              - conditions:
                  - "{{ not (master_forced_min_active | bool(false)) }}"
                  - "{{ (master_needs_global_boost | bool(false)) or (master_significant_drop | bool(false)) }}"
                  - "{{ (master_target_delta_abs | float(0)) > 0.1 }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target_with_boost }}"
                    continue_on_error: true
                  - delay:
                      seconds: 2
                  - condition: template
                    value_template: >
                      {{ ((state_attr(inputs.master_climate, 'temperature') | float(0)) - (master_required_target_with_boost | float(0))) | abs <= 0.11 }}
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
              # PATH C (COMFORT): regular writes follow cooldown policy
              - conditions:
                  - "{{ master_write_allowed }}"
                sequence:
                  - service: climate.set_temperature
                    target:
                      entity_id: "{{ inputs.master_climate }}"
                    data:
                      temperature: "{{ master_required_target_with_boost }}"
                    continue_on_error: true
                  - delay:
                      seconds: 2
                  - condition: template
                    value_template: >
                      {{ ((state_attr(inputs.master_climate, 'temperature') | float(0)) - (master_required_target_with_boost | float(0))) | abs <= 0.11 }}
                  - service: input_datetime.set_datetime
                    target:
                      entity_id: "{{ inputs.master_last_write_helper }}"
                    data:
                      datetime: "{{ now() }}"
                    continue_on_error: true
